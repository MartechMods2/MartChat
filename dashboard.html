<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Mod Hive Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background-color: #0f0f0f;
      color: #ffffff;
      font-family: 'Montserrat', sans-serif;
    }

    .sidebar {
      width: 60px;
      background: #111;
      border-right: 2px solid #00f0ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 10px;
      min-height: 100vh;
      transition: width 0.3s;
    }

    .sidebar button {
      width: 40px;
      height: 40px;
      margin-bottom: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #1a1a1a;
      border: 2px solid #00f0ff;
      color: #00f0ff;
      border-radius: 12px;
      font-size: 1.1rem;
      transition: 0.3s;
    }

    .sidebar button:hover {
      background: #00f0ff;
      color: #000;
      transform: scale(1.05);
    }

    .collapsed {
      width: 0 !important;
      overflow: hidden !important;
    }

    .main-area {
      margin-left: 70px;
      padding: 2rem;
    }

    .section {
      display: none;
    }

    .active-section {
      display: block;
    }

    .xp-bar-bg {
      width: 100%;
      height: 12px;
      background: #333;
      border-radius: 6px;
      margin-top: 6px;
    }

    .xp-bar-fill {
      height: 100%;
      background: #00f0ff;
      width: 40%;
      border-radius: 6px;
    }

    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #00f0ff;
      color: #000;
      padding: 8px 16px;
      border-radius: 6px;
      display: none;
    }
  </style>
</head>

<body>

  <!-- Toggle button for sidebar -->
  <button onclick="toggleSidebar()" class="fixed top-2 left-2 z-50 bg-[#111] p-2 rounded text-cyan-400">‚ò∞</button>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <button onclick="showSection('home')" title="Home">üè†</button>
    <button onclick="showSection('posts')" title="Posts">üñä</button>
    <button onclick="showSection('global')" title="Global Chat">üí¨</button>
    <button onclick="showSection('private')" title="DM">üì®</button>
    <button onclick="showSection('friends')" title="Friends">üë•</button>
    <button onclick="showSection('leaderboard')" title="Leaderboard">üèÜ</button>
    <button onclick="showSection('settings')" title="Settings">‚öôÔ∏è</button>
  </div>

  <!-- Main area -->
  <div class="main-area">
    <!-- Home Section -->
    <div id="home" class="section active-section">
      <h1 class="text-2xl font-bold mb-2">Welcome, <span id="nicknameDisplay">Player</span>!</h1>
      <p>Points: <span id="pointsDisplay">0</span></p>
      <p>Rank: <span id="rankDisplay">Rookie</span></p>
      <!-- XP Bar -->
      <div class="xp-bar-bg">
        <div class="xp-bar-fill"></div>
      </div>

      <!-- Quick Buttons -->
      <div class="mt-4">
        <button onclick="showSection('posts')" class="bg-cyan-500 text-black px-4 py-2 rounded mr-2">+ New Post</button>
        <button onclick="showSection('global')" class="bg-cyan-500 text-black px-4 py-2 rounded">Open Global Chat</button>
      </div>
    </div><!-- POSTS Section -->
    <div id="posts" class="section">
      <h2 class="text-xl font-bold mb-4">Create Post</h2>
      <textarea id="postText" rows="3" class="w-full bg-[#1a1a1a] rounded p-2 mb-2" placeholder="What's on your mind?"></textarea>
      <input id="postUrl" class="w-full bg-[#1a1a1a] rounded p-2 mb-2" placeholder="Image or Link URL (optional)">
      <button onclick="createPost()" class="bg-cyan-500 text-black px-4 py-2 rounded mb-4">Post</button>

      <h3 class="text-lg font-semibold mb-2">Recent Posts</h3>
      <div id="postFeed"></div>
    </div>

    <!-- GLOBAL CHAT Section -->
    <div id="global" class="section">
      <h2 class="text-xl font-bold mb-4">Global Chat</h2>
      <div id="globalMessages" class="bg-[#1a1a1a] rounded p-2 mb-2" style="height:300px; overflow-y:auto;">
        <!-- Global chat messages will go here -->
      </div>
      <div class="flex gap-2">
        <input id="globalInput" class="flex-1 bg-[#1a1a1a] rounded p-2" placeholder="Type a message...">
        <button onclick="sendGlobal()" class="bg-cyan-500 text-black px-4 py-2 rounded">Send</button>
      </div>
    </div>

    <!-- PRIVATE CHAT Section -->
    <div id="private" class="section">
      <h2 class="text-xl font-bold mb-4">Private Chat</h2>
      <label class="text-sm">Select Friend:</label>
      <select id="dmSelect" class="mb-2 p-2 bg-[#1a1a1a] rounded"></select>
      <div id="privateMessages" class="bg-[#1a1a1a] rounded p-2 mb-2" style="height:300px; overflow-y:auto;"></div>
      <input id="privateInput" placeholder="Message..." class="mb-2 p-2 bg-[#1a1a1a] rounded"/>
      <button onclick="sendPrivate()" class="bg-cyan-500 text-black px-4 py-2 rounded">Send</button>
    </div>

    <!-- FRIENDS Section -->
    <div id="friends" class="section">
      <h2 class="text-xl font-bold mb-4">Friends List</h2>
      <div id="friendList"></div>
    </div>

    <!-- LEADERBOARD Section -->
    <div id="leaderboard" class="section">
      <h2 class="text-xl font-bold mb-4">Leaderboard</h2>
      <div id="leaderboardList"></div>
    </div>

    <!-- ACCOUNT SETTINGS Section -->
    <div id="settings" class="section">
      <h2 class="text-xl font-bold mb-4">Account Settings</h2>
      <input id="nicknameInput" class="bg-[#1a1a1a] rounded p-2 mb-2" placeholder="Nickname"/>
      <input id="photoInput" class="bg-[#1a1a1a] rounded p-2 mb-2" placeholder="Photo URL"/>
      <textarea id="bioInput" rows="3" class="bg-[#1a1a1a] rounded p-2 mb-2" placeholder="Bio"></textarea>
      <button onclick="saveAccount()" class="bg-cyan-500 text-black px-4 py-2 rounded">Save</button>
    </div>

  </div> <!-- end .main-area -->

  <!-- Toast popup -->
  <div id="toast"></div><!-- START OF FULL JAVASCRIPT -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAgx0jy6we6cvnIgKbS1fBoeRfSD2MDszo",
  authDomain: "mod-hive.firebaseapp.com",
  projectId: "mod-hive",
  storageBucket: "mod-hive.firebasestorage.app",
  messagingSenderId: "982583858832",
  appId: "1:982583858832:web:44d5e4e2edd77fac06ea15",
  measurementId: "G-PK2DRED7FB"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
const ADMIN_UID = "7aTPZ6wEIpQaPjlXWDrz5Ajc4By1";

// ---- Global Functions ----
window.showSection = function(id){
  document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active-section'));
  document.getElementById(id).classList.add('active-section');
  if(id === 'global'){
    newGlobalCount = 0;
    document.querySelector("button[onclick*='showSection(\\'global\\')']").textContent = "üí¨";
  }
};

function linkify(text){
  return text.replace(/(https?:\/\/\S+)/g, function(url){
    return `<a href="${url}" target="_blank">${url}</a>`;
  });
}

function showToast(msg){
  const t = document.getElementById('toast');
  t.innerText = msg;
  t.style.display = 'block';
  setTimeout(()=>{ t.style.display='none'; }, 2000);
}

/* USER */
let user = null;
let userData = {};
let friends = [];

/* AUTH & INIT */
auth.onAuthStateChanged(async function(u){
  if(!u) return window.location.href='auth.html';
  user = u;
  const docRef = db.collection("users").doc(u.uid);
  const docSnap = await docRef.get();
  if(!docSnap.exists()){
    await docRef.set({
      nickname: u.email.split('@')[0],
      points: 0,
      rank: 'Rookie',
      friends: []
    });
  }
  userData = (await docRef.get()).data();
  document.getElementById('nicknameDisplay').innerText = userData.nickname;
  document.getElementById('pointsDisplay').innerText   = userData.points;
  document.getElementById('rankDisplay').innerText     = userData.rank;
  friends = userData.friends || [];

  loadPosts();
  loadGlobalChat();
  loadLeaderboard();
  loadFriendsList();
  loadPrivateFriendSelector();
  updateXPandRank();
});

function logout(){ auth.signOut(); }

/* ACCOUNT UPDATE */
async function saveAccount(){
  const nickname = document.getElementById('nicknameInput').value;
  const photo    = document.getElementById('photoInput').value;
  const bio      = document.getElementById('bioInput').value;
  await db.collection("users").doc(user.uid).update({
    nickname, profilePhoto: photo, bio
  });
  showToast("Saved!");
  document.getElementById('nicknameDisplay').innerText = nickname;
}
/* CREATE & LOAD POSTS */
function createPost(){
  const text  = document.getElementById('postText').value.trim();
  const media = document.getElementById('postUrl').value.trim();
  if(!text) return;
  db.collection("posts").add({
    uid: user.uid,
    author: userData.nickname,
    text,
    media,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    likes: []
  });
  db.collection("users").doc(user.uid).update({
    points: firebase.firestore.FieldValue.increment(5)
  });
  showToast("+5 Points (Post)");
  document.getElementById('postText').value  = "";
  document.getElementById('postUrl').value   = "";
  updateXPandRank();
}

function loadPosts(){
  db.collection("posts").orderBy("createdAt","desc")
    .onSnapshot(snap => {
      const feed = document.getElementById('postFeed');
      feed.innerHTML = "";
      snap.forEach(doc => {
        const p = doc.data();
        const div = document.createElement("div");
        div.className = "bg-[#1a1a1a] border border-cyan-500 p-3 rounded mb-3";
        div.innerHTML = `
          <p class="font-bold">${p.author}</p>
          <p>${linkify(p.text)}</p>
          ${p.media ? `<a class="text-cyan-300" href="${p.media}" target="_blank">View Media</a>` : ""}
          <button onclick="likePost('${doc.id}')">üëç ${p.likes.length}</button>
          ${(user.uid===ADMIN_UID || user.uid===p.uid) ? `<button onclick="deletePost('${doc.id}')">üóë</button>` : ""}
        `;
        feed.appendChild(div);
      });
    });
}

function likePost(id){
  db.collection("posts").doc(id).update({
    likes: firebase.firestore.FieldValue.arrayUnion(user.uid)
  });
  db.collection("users").doc(user.uid).update({
    points: firebase.firestore.FieldValue.increment(1)
  });
  updateXPandRank();
}

function deletePost(id){
  db.collection("posts").doc(id).delete();
}

/* GLOBAL CHAT */
let newGlobalCount = 0;

function sendGlobal(){
  const text = document.getElementById('globalInput').value.trim();
  if(!text) return;
  db.collection("globalChat").add({
    author: userData.nickname,
    text,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  db.collection("users").doc(user.uid).update({
    points: firebase.firestore.FieldValue.increment(1)
  });
  document.getElementById('globalInput').value = "";
  updateXPandRank();
}

function loadGlobalChat(){
  db.collection("globalChat").orderBy("createdAt")
    .onSnapshot(snap => {
      const box = document.getElementById('globalMessages');
      box.innerHTML = "";
      snap.forEach(doc => {
        const m = doc.data();
        const p = document.createElement("p");
        p.innerHTML = `<b>${m.author}</b>: ${linkify(m.text)}`;
        box.appendChild(p);
      });
      box.scrollTop = box.scrollHeight;

      // notify badge
      if(!document.getElementById('global').classList.contains('active-section')){
        newGlobalCount++;
        document.querySelector("button[onclick*='showSection(\\'global\\')']").textContent = "üí¨(" + newGlobalCount + ")";
      }
    });
}

/* PRIVATE CHAT */
function loadPrivateFriendSelector(){
  const s = document.getElementById('dmSelect');
  s.innerHTML = "";
  friends.forEach(f=>{
    const opt = document.createElement("option");
    opt.value = f; opt.textContent = f;
    s.appendChild(opt);
  });
}

function sendPrivate(){
  const fuid = document.getElementById('dmSelect').value;
  const text = document.getElementById('privateInput').value.trim();
  if(!text) return;
  const chatId = ([user.uid,fuid]).sort().join("_");
  db.collection("privateChats").doc(chatId).collection("messages")
    .add({
      uid: user.uid,
      author: userData.nickname,
      text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  document.getElementById('privateInput').value = "";
}

document.getElementById('dmSelect')?.addEventListener('change', ()=>{
  const f = document.getElementById('dmSelect').value;
  const chatId = ([user.uid,f]).sort().join("_");
  db.collection("privateChats").doc(chatId).collection("messages")
    .orderBy("createdAt")
    .onSnapshot(snap => {
      const box = document.getElementById('privateMessages');
      box.innerHTML = "";
      snap.forEach(mdoc => {
        const m = mdoc.data();
        const row = document.createElement("p");
        row.innerHTML = `<b>${m.author}</b>: ${linkify(m.text)}`;
        box.appendChild(row);
      });
      box.scrollTop = box.scrollHeight;
    });
});

/* FRIEND LIST */
function loadFriendsList(){
  const list = document.getElementById('friendList');
  list.innerHTML = "";
  friends.forEach(async f=>{
    const fd = await db.collection("users").doc(f).get();
    const data = fd.data();
    const div = document.createElement("div");
    div.innerHTML = `
      <b>${data.nickname || f}</b>
      <button onclick="startDM('${f}')" class="ml-2 text-xs bg-cyan-500 text-black px-2 py-1 rounded">Chat</button>
    `;
    list.appendChild(div);
  });
}

function startDM(uid){
  document.getElementById('dmSelect').value = uid;
  showSection('private');
  const evt = new Event('change');
  document.getElementById('dmSelect').dispatchEvent(evt);
}

/* LEADERBOARD */
function loadLeaderboard(){
  db.collection("users").orderBy("points","desc").limit(10).onSnapshot(snap=>{
    const list = document.getElementById('leaderboardList');
    list.innerHTML="";
    snap.forEach(doc=>{
      const d=doc.data();
      const row=document.createElement("div");
      row.innerHTML = `<b>${d.nickname}</b> - ${d.points} pts`;
      list.appendChild(row);
    });
  });
}

/* XP / Rank update */
function updateXPandRank(){
  const pts = userData.points || 0;
  const fill = document.querySelector('.xp-bar-fill');
  const percent = Math.min((pts%100)/100*100,100);
  fill.style.width = percent + '%';
  // rank text is handled above on auth
}

/* SIDEBAR TOGGLE */
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('collapsed');
}
</script>
<!-- END SCRIPT --><footer class="text-center text-gray-500 py-4">
  ¬© 2024 Mod Hive. All rights reserved.
</footer><!-- Closing all -->
  <!-- Toast element is already included above -->

</body>
</html>
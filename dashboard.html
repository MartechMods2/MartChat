<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mod Hive — Live Dashboard</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <!-- Theme & little UX sugar -->
  <style>
    :root{
      --mh-primary:#6c5ce7; --mh-primary-2:#5649c0;
      --mh-accent:#00cec9;  --mh-pink:#fd79a8;
      --mh-dark:#0e1217;    --mh-darker:#0b0f13; --mh-panel:#151b22;
      --mh-muted:#93a1b1;   --mh-soft:#222a35;   --mh-ok:#10b981; --mh-warn:#f59e0b; --mh-danger:#ef4444;
    }
    html,body{background:var(--mh-dark); color:#e8eef6;}
    .glass{background:linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.06)}
    .btn{transition: transform .12s ease, box-shadow .12s ease}
    .btn:active{transform: scale(.98)}
    .nav-active{background: rgba(255,255,255,.06)}
    .fade-in{animation:fade .25s ease both}
    @keyframes fade{from{opacity:0; transform: translateY(4px)} to{opacity:1; transform:none}}
    .ellipsis-2{display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden}
    .scroll-y{scrollbar-width:thin}
    .reaction-btn{min-width:3.5rem}
    .modal-open{overflow:hidden}
    .chip{background:#ffffff14;border:1px solid #ffffff24;padding:.25rem .5rem;border-radius:.375rem;font-size:.75rem}
    .tooltip { position: relative; }
    .tooltip:hover::after {
      content: attr(data-tip); position:absolute; bottom:calc(100% + 6px); left:50%; transform:translateX(-50%);
      background:#111827; color:#fff; font-size:.7rem; padding:.2rem .45rem; border-radius:.25rem; white-space:nowrap; border:1px solid #ffffff22;
    }
    
    /* Responsive additions */
    @media (max-width: 768px) {
      .container-padding {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }
      
      .mobile-full-width {
        width: 100vw;
        margin-left: calc(-50vw + 50%);
      }
      
      .mobile-stack {
        flex-direction: column;
      }
      
      .mobile-text-sm {
        font-size: 0.875rem;
      }
      
      .mobile-p-2 {
        padding: 0.5rem;
      }
      
      .mobile-hidden {
        display: none;
      }
      
      .mobile-visible {
        display: block;
      }
      
      .post-actions-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
      
      .chat-input-grid {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.5rem;
      }
    }
    
    @media (max-width: 640px) {
      .mobile-collapse {
        display: none;
      }
      
      .profile-dropdown {
        position: static;
      }
      
      .search-box {
        width: 100%;
        max-width: 100%;
      }
      
      .leaderboard-table {
        font-size: 0.75rem;
      }
      
      .leaderboard-table th, 
      .leaderboard-table td {
        padding: 0.25rem;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-visible {
        display: none;
      }
    }
  </style>
</head>

<body class="h-full">
  <!-- ===== Gate ===== -->
  <div id="gate" class="fixed inset-0 flex items-center justify-center bg-[var(--mh-dark)] z-50">
    <div class="glass p-8 rounded-xl w-[92%] max-w-md text-center">
      <h1 class="text-2xl font-semibold mb-2">Mod Hive</h1>
      <p class="text-sm text-[var(--mh-muted)]">Checking session…</p>
    </div>
  </div>

  <!-- ===== App ===== -->
  <div id="app" class="min-h-screen hidden">
    <!-- Top Bar -->
    <header class="w-full sticky top-0 z-40 bg-[var(--mh-darker)]/90 backdrop-blur border-b border-white/5 mobile-full-width">
      <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 h-16 flex items-center justify-between container-padding">
        <div class="flex items-center gap-3">
          <button id="btnOpenSidebar" class="md:hidden p-2 rounded hover:bg-white/10" aria-label="Open menu">
            <i class="fa-solid fa-bars"></i>
          </button>
          <div class="flex items-center gap-2">
            <span class="inline-flex items-center justify-center w-8 h-8 rounded bg-[var(--mh-primary)] text-white font-bold">MH</span>
            <h1 class="text-lg font-semibold tracking-wide mobile-text-sm">Mod Hive</h1>
          </div>
        </div>

        <div class="flex items-center gap-2 sm:gap-3">
          <!-- Search -->
          <div class="hidden md:flex items-center bg-[var(--mh-panel)] rounded px-3 py-1 search-box">
            <i class="fa-solid fa-magnifying-glass text-white/50 mr-2"></i>
            <input id="searchBox" placeholder="Search posts, users…" class="bg-transparent outline-none text-sm placeholder-white/40 w-60" />
          </div>

          <!-- Theme -->
          <button id="btnTheme" class="p-2 rounded hover:bg-white/10 tooltip mobile-p-2" data-tip="Toggle theme">
            <i class="fa-regular fa-moon"></i>
          </button>

          <!-- Notifications -->
          <button id="btnOpenNotifications" class="relative p-2 rounded hover:bg-white/10 mobile-p-2">
            <i class="fa-regular fa-bell"></i>
            <span id="notifDot" class="hidden absolute -top-0.5 -right-0.5 w-2.5 h-2.5 rounded-full bg-[var(--mh-pink)]"></span>
          </button>

          <!-- Profile dropdown -->
          <div class="relative profile-dropdown">
            <button id="profileToggle" class="flex items-center gap-2 sm:gap-3 hover:bg-white/10 px-2 py-1 rounded">
              <img id="navAvatar" class="w-8 h-8 rounded object-cover" src="https://i.pravatar.cc/80?img=3" alt="">
              <div class="hidden sm:block text-left mobile-collapse">
                <div id="navNick" class="text-sm font-medium">Player</div>
                <div class="text-[11px] text-white/50">Level <span id="navRank">1</span> · <span id="navPoints">0</span> pts</div>
              </div>
              <i class="fa-solid fa-chevron-down text-xs ml-1 mobile-collapse"></i>
            </button>
            <div id="profileMenu" class="hidden absolute right-0 mt-2 w-56 glass rounded-lg p-2">
              <button data-section="profile" class="w-full text-left px-3 py-2 rounded hover:bg-white/10">Profile / Settings</button>
              <button data-section="notifications" class="w-full text-left px-3 py-2 rounded hover:bg-white/10">Notifications</button>
              <button id="btnLogout" class="w-full text-left px-3 py-2 rounded hover:bg-white/10 text-red-400">Log out</button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Layout -->
    <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-6 grid grid-cols-12 gap-6 container-padding">
      <!-- Sidebar -->
      <aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-[18.5rem] md:w-auto md:col-span-3 bg-[var(--mh-darker)] md:bg-transparent md:translate-x-0 -translate-x-full transition-transform z-40">
        <div class="md:sticky md:top-20 p-4 md:p-0 h-full overflow-y-auto scroll-y">
          <nav class="space-y-2">
            <button data-section="feed" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-lg glass nav-active">
              <i class="fa-solid fa-house"></i><span>Feed</span>
            </button>
            <button data-section="chat" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-lg glass">
              <i class="fa-solid fa-message"></i><span>Chat</span>
            </button>
            <button data-section="friends" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-lg glass">
              <i class="fa-solid fa-user-group"></i><span>Friends</span>
            </button>
            <button data-section="leaderboard" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-lg glass">
              <i class="fa-solid fa-trophy"></i><span>Leaderboard</span>
            </button>
            <button data-section="notifications" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-lg glass">
              <i class="fa-solid fa-bell"></i><span>Notifications</span>
            </button>
            <button data-section="profile" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-lg glass">
              <i class="fa-solid fa-id-card"></i><span>Profile</span>
            </button>
            <a href="ModHive.html" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg glass hover:bg-white/10">
              <i class="fa-solid fa-rotate-left"></i><span>Back to Main</span>
            </a>
          </nav>

          <!-- Quick status -->
          <div class="mt-6 glass rounded-xl p-4">
            <div class="flex items-center gap-3">
              <div class="relative">
                <img id="sideAvatar" class="w-12 h-12 rounded object-cover" src="https://i.pravatar.cc/80?img=4" />
                <span class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-[var(--mh-ok)] rounded-full border-2 border-[var(--mh-darker)]"></span>
              </div>
              <div>
                <div id="sideNick" class="font-semibold">Player</div>
                <div class="text-xs text-white/50">Points: <span id="sidePoints">0</span></div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Overlay (mobile) -->
      <div id="overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

      <!-- Main -->
      <main class="col-span-12 md:col-span-9 space-y-6">
        <!-- ===== FEED ===== -->
        <section id="section-feed" class="space-y-6 fade-in">
          <!-- Create Post -->
          <div class="glass rounded-xl p-4">
            <div class="flex items-start gap-3">
              <img id="cpAvatar" class="w-10 h-10 rounded object-cover" src="https://i.pravatar.cc/80?img=5" />
              <div class="flex-1">
                <textarea id="postText" class="w-full bg-[var(--mh-panel)] rounded-lg p-3 outline-none" rows="2" placeholder="Share your moment…"></textarea>
                <div class="mt-3 flex flex-wrap items-center gap-2 mobile-stack">
                  <label class="cursor-pointer px-3 py-1.5 rounded bg-white/5 hover:bg-white/10 mobile-full-width mobile-text-center">
                    <i class="fa-regular fa-image mr-2"></i> Image
                    <input id="postImage" type="file" accept="image/*" class="hidden">
                  </label>
                  <div class="flex items-center gap-2 bg-[var(--mh-panel)] rounded px-3 py-1.5 mobile-full-width">
                    <i class="fa-solid fa-link text-white/60"></i>
                    <input id="postLink" placeholder="Link (optional)" class="bg-transparent outline-none text-sm w-56 mobile-full-width"/>
                  </div>
                  <button id="btnPost" class="ml-auto btn px-4 py-2 rounded bg-[var(--mh-primary)] hover:bg-[var(--mh-primary-2)] mobile-full-width mt-2">Post</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Posts -->
          <div id="feedList" class="space-y-4"></div>
          <button id="btnMore" class="hidden mx-auto block px-4 py-2 glass rounded hover:bg-white/10">Load more</button>
        </section>

        <!-- ===== CHAT ===== -->
        <section id="section-chat" class="hidden space-y-4 fade-in">
          <div class="grid md:grid-cols-12 gap-4 mobile-stack">
            <!-- Left: friend list -->
            <div class="md:col-span-4 glass rounded-xl p-4 mobile-full-width">
              <div class="flex items-center gap-2 mb-3">
                <i class="fa-solid fa-message"></i><h3 class="font-semibold">Private Chats</h3>
              </div>
              <input id="chatSearch" class="w-full bg-[var(--mh-panel)] rounded px-3 py-2 outline-none mb-3" placeholder="Search user…"/>
              <div id="chatUsers" class="space-y-2 max-h-[60vh] overflow-y-auto scroll-y"></div>
            </div>

            <!-- Right: conversation -->
            <div class="md:col-span-8 glass rounded-xl p-4 flex flex-col h-[70vh] mobile-full-width">
              <div class="flex items-center justify-between border-b border-white/5 pb-2 mobile-stack">
                <div class="flex items-center gap-3">
                  <img id="chatPeerAvatar" class="w-10 h-10 rounded object-cover" src="https://i.pravatar.cc/80?img=6">
                  <div>
                    <div id="chatPeerNick" class="font-semibold">Select a friend</div>
                    <div id="chatPeerStatus" class="text-xs text-white/50">—</div>
                  </div>
                </div>
                <div class="text-white/50 text-sm flex items-center gap-3 mobile-stack mobile-mt-2">
                  <span class="chip" id="typingChip" style="display:none;">typing…</span>
                  <span class="chip mobile-hidden">Encrypted 1-on-1</span>
                </div>
              </div>

              <div id="chatStream" class="flex-1 my-3 overflow-y-auto scroll-y space-y-3"></div>

              <div class="mt-2 flex items-center gap-2 chat-input-grid">
                <input id="chatInput" class="flex-1 bg-[var(--mh-panel)] rounded px-3 py-2 outline-none" placeholder="Type a message… (Enter to send)">
                <button id="btnSendChat" class="btn px-3 py-2 rounded bg-[var(--mh-primary)] hover:bg-[var(--mh-primary-2)]"><i class="fa-solid fa-paper-plane"></i></button>
              </div>
            </div>
          </div>
        </section>

        <!-- ===== FRIENDS ===== -->
        <section id="section-friends" class="hidden space-y-4 fade-in">
          <div class="grid md:grid-cols-2 gap-4 mobile-stack">
            <!-- Suggestions -->
            <div class="glass rounded-xl p-4 mobile-full-width">
              <div class="flex items-center gap-2 mb-3"><i class="fa-solid fa-user-plus"></i><h3 class="font-semibold">Friend Suggestions</h3></div>
              <div id="friendSuggestions" class="grid sm:grid-cols-2 gap-3"></div>
            </div>
            <!-- Requests -->
            <div class="glass rounded-xl p-4 mobile-full-width">
              <div class="flex items-center gap-2 mb-3"><i class="fa-solid fa-inbox"></i><h3 class="font-semibold">Requests</h3></div>
              <div id="incomingRequests" class="space-y-2"></div>
            </div>
          </div>
          <!-- Your Friends -->
          <div class="glass rounded-xl p-4 mobile-full-width">
            <div class="flex items-center gap-2 mb-3"><i class="fa-solid fa-user-group"></i><h3 class="font-semibold">Your Friends</h3></div>
            <div id="friendList" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
          </div>
        </section>

        <!-- ===== LEADERBOARD ===== -->
        <section id="section-leaderboard" class="hidden space-y-4 fade-in">
          <div class="glass rounded-xl p-4 mobile-full-width">
            <div class="flex items-center gap-2 mb-4"><i class="fa-solid fa-trophy text-yellow-400"></i><h3 class="font-semibold">Top Players</h3></div>
            <div class="overflow-auto">
              <table class="min-w-full text-sm leaderboard-table">
                <thead class="text-white/60">
                  <tr><th class="text-left py-2 px-2">#</th><th class="text-left py-2 px-2">Player</th><th class="text-left py-2 px-2">Nickname</th><th class="text-left py-2 px-2">Points</th><th class="text-left py-2 px-2">Rank</th></tr>
                </thead>
                <tbody id="leaderRows"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ===== NOTIFICATIONS ===== -->
        <section id="section-notifications" class="hidden space-y-4 fade-in">
          <div class="glass rounded-xl p-4 mobile-full-width">
            <div class="flex items-center gap-2 mb-3"><i class="fa-solid fa-bell"></i><h3 class="font-semibold">Notifications</h3></div>
            <div id="notifList" class="space-y-2"></div>
          </div>
        </section>

        <!-- ===== PROFILE ===== -->
        <section id="section-profile" class="hidden space-y-4 fade-in">
          <div class="glass rounded-xl p-4 mobile-full-width">
            <div class="flex items-center gap-2 mb-4"><i class="fa-solid fa-id-card"></i><h3 class="font-semibold">Profile & Account</h3></div>

            <!-- Extended profile -->
            <div class="grid md:grid-cols-2 gap-6 mobile-stack">
              <div class="mobile-full-width">
                <label class="text-sm text-white/70">Gamer Nickname</label>
                <input id="setNick" class="w-full bg-[var(--mh-panel)] rounded px-3 py-2 outline-none" placeholder="Your nickname">
              </div>
              <div class="mobile-full-width">
                <label class="text-sm text-white/70">Gamer Name (display)</label>
                <input id="setGamer" class="w-full bg-[var(--mh-panel)] rounded px-3 py-2 outline-none" placeholder="Shown on posts">
              </div>
              <div class="mobile-full-width">
                <label class="text-sm text-white/70">Sex</label>
                <select id="setSex" class="w-full bg-[var(--mh-panel)] rounded px-3 py-2 outline-none">
                  <option value="">Prefer not to say</option>
                  <option>Female</option><option>Male</option><option>Non-binary</option><option>Other</option>
                </select>
              </div>
              <div class="mobile-full-width">
                <label class="text-sm text-white/70">Date of Birth</label>
                <input id="setDOB" type="date" class="w-full bg-[var(--mh-panel)] rounded px-3 py-2 outline-none">
              </div>
              <div class="mobile-full-width">
                <label class="text-sm text-white/70">Language</label>
                <input id="setLang" class="w-full bg-[var(--mh-panel)] rounded px-3 py-2 outline-none" placeholder="e.g., English">
              </div>
              <div class="mobile-full-width">
                <label class="text-sm text-white/70">Country</label>
                <input id="setCountry" class="w-full bg-[var(--mh-panel)] rounded px-3 py-2 outline-none" placeholder="e.g., Nigeria">
              </div>
              <div class="md:col-span-2 mobile-full-width">
                <label class="text-sm text-white/70">Games You Play (comma separated)</label>
                <input id="setGames" class="w-full bg-[var(--mh-panel)] rounded px-3 py-2 outline-none" placeholder="e.g., CODM, FIFA, Fortnite">
              </div>
              <div class="mobile-full-width">
                <label class="text-sm text-white/70">Status</label>
                <select id="setStatus" class="w-full bg-[var(--mh-panel)] rounded px-3 py-2 outline-none">
                  <option value="online">Online</option>
                  <option value="ingame">In-game</option>
                  <option value="offline">Offline</option>
                </select>
              </div>
              <div class="mobile-full-width">
                <label class="text-sm text-white/70">Avatar (base64 — free)</label>
                <input id="setAvatar" type="file" accept="image/*" class="w-full bg-[var(--mh-panel)] rounded px-3 py-2 outline-none">
                <p class="text-xs text-white/50 mt-1">Saved as compressed base64 in Firestore (no Storage needed).</p>
              </div>
              <div class="md:col-span-2 mobile-full-width">
                <label class="text-sm text-white/70">Bio</label>
                <textarea id="setBio" rows="3" class="w-full bg-[var(--mh-panel)] rounded px-3 py-2 outline-none" placeholder="Tell others about your gaming…"></textarea>
              </div>
              <div class="md:col-span-2 mobile-full-width">
                <label class="text-sm text-white/70">Privacy</label>
                <div class="mt-2 space-y-2">
                  <label class="flex items-center gap-2 text-sm"><input id="privDOB" type="checkbox" class="accent-[var(--mh-primary)]"> Hide DOB from others</label>
                  <label class="flex items-center gap-2 text-sm"><input id="privEmail" type="checkbox" class="accent-[var(--mh-primary)]"> Hide email from others</label>
                </div>
              </div>
            </div>

            <div class="mt-4 flex items-center gap-2">
              <button id="btnSaveProfile" class="btn px-4 py-2 rounded bg-[var(--mh-primary)] hover:bg-[var(--mh-primary-2)]">Save</button>
              <span id="profileSaved" class="hidden text-[var(--mh-ok)] text-sm">Saved ✓</span>
            </div>
          </div>

          <!-- Admin tools -->
          <div class="glass rounded-xl p-4 mobile-full-width">
            <div class="flex items-center gap-2 mb-2"><i class="fa-solid fa-shield-halved text-red-400"></i><h3 class="font-semibold">Admin Tools</h3></div>
            <p class="text-sm text-white/60">Delete posts/comments globally. Only works for your admin UID.</p>
            <div class="mt-3 grid sm:grid-cols-3 gap-3 mobile-stack">
              <input id="adminDeletePostId" class="bg-[var(--mh-panel)] rounded px-3 py-2 outline-none mobile-full-width" placeholder="Post ID to delete">
              <button id="btnAdminDeletePost" class="btn px-4 py-2 rounded bg-[var(--mh-danger)] hover:bg-red-600 mobile-full-width">Delete Post</button>
              <button id="btnBanUser" class="btn px-4 py-2 rounded bg-red-500/40 hover:bg-red-500/60 mobile-full-width">Soft Ban (toggle)</button>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- ===== Image Lightbox ===== -->
  <div id="imgLight" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-[60]">
    <button id="imgClose" class="absolute top-3 right-3 p-2 rounded bg-white/10 hover:bg-white/20"><i class="fa-solid fa-xmark"></i></button>
    <img id="imgLarge" class="max-h-[88vh] max-w-[92vw] rounded-lg shadow-2xl object-contain" src="" alt="">
  </div>

  <!-- ===== View Profile Modal ===== -->
  <div id="profileModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-[60]">
    <div class="glass rounded-xl w-[92vw] max-w-2xl p-4 relative">
      <button id="pmClose" class="absolute top-3 right-3 p-2 rounded bg-white/10 hover:bg-white/20"><i class="fa-solid fa-xmark"></i></button>
      <div class="flex items-start gap-4 mobile-stack">
        <img id="pmAvatar" class="w-20 h-20 rounded object-cover" src="">
        <div class="flex-1">
          <div class="text-xl font-semibold" id="pmName">—</div>
          <div class="text-sm text-white/60" id="pmUid">—</div>
          <div class="flex flex-wrap gap-2 mt-2" id="pmChips"></div>
        </div>
        <div class="space-x-2 mobile-stack mobile-mt-2">
          <button id="pmAdd" class="px-3 py-1.5 rounded bg-white/10 hover:bg-white/20 mobile-full-width">Add Friend</button>
          <button id="pmMsg" class="px-3 py-1.5 rounded bg-[var(--mh-primary)]/70 hover:bg-[var(--mh-primary-2)]/80 mobile-full-width">Message</button>
        </div>
      </div>
      <div class="mt-4 grid md:grid-cols-2 gap-4 text-sm mobile-stack">
        <div class="mobile-full-width">
          <div class="text-white/70 mb-1">Bio</div>
          <div id="pmBio" class="bg-white/5 rounded p-3 min-h-[64px]"></div>
        </div>
        <div class="mobile-full-width">
          <div class="text-white/70 mb-1">Public Info</div>
          <div id="pmPublic" class="bg-white/5 rounded p-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Firebase SDKs (module) ===== -->
  <script type="module">
    /************* Firebase bootstrap *************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, GithubAuthProvider,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, serverTimestamp,
      onSnapshot, query, where, orderBy, limit, startAfter, getDocs, deleteDoc, arrayUnion, arrayRemove, increment
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    /* ========= CONFIG — REPLACE THIS ========= */
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAgx0jy6we6cvnIgKbS1fBoeRfSD2MDszo",
  authDomain: "mod-hive.firebaseapp.com",
  projectId: "mod-hive",
  storageBucket: "mod-hive.firebasestorage.app",
  messagingSenderId: "982583858832",
  appId: "1:982583858832:web:44d5e4e2edd77fac06ea15",
  measurementId: "G-PK2DRED7FB"
};
    const ADMIN_UID = "7aTPZ6wEIpQaPjlXWDrz5Ajc4By1"; // <- your admin uid

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ========= STATE ========= */
    let me = null;          // current user auth object
    let meDoc = null;       // cached user document data
    let chatPeer = null;
    let chatUnsub = null;
    let feedUnsub = null;
    let notifUnsub = null;

    /* ========= Helpers ========= */
    const $  = sel => document.querySelector(sel);
    const $$ = sel => [...document.querySelectorAll(sel)];
    const byId = id => document.getElementById(id);
    const sleep = ms => new Promise(r=>setTimeout(r,ms));
    const nowTs = () => serverTimestamp();

    function shortId(id){ return id?.slice(0,6)+"…"; }
    function rankFromPoints(p=0){
      if(p>2000) return 10; if(p>1000) return 9; if(p>600) return 8; if(p>400) return 7;
      if(p>250) return 6; if(p>150) return 5; if(p>90) return 4; if(p>50) return 3; if(p>20) return 2; return 1;
    }
    function tsToText(ts){
      try{ const d = ts?.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString(); }catch{ return "just now"; }
    }
    const md = s => s?.replace?.(/\n/g,'<br>') || "";

    // file -> base64 (compressed)
    function fileToBase64(file, maxW=1000, quality=0.82){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = e=>{
          const img = new Image();
          img.onload = ()=>{
            const scale = Math.min(1, maxW/img.width);
            const w = Math.round(img.width*scale);
            const h = Math.round(img.height*scale);
            const canvas = document.createElement('canvas');
            canvas.width=w; canvas.height=h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img,0,0,w,h);
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /* ========= THEME ========= */
    const btnTheme = byId('btnTheme');
    btnTheme.addEventListener('click', ()=>{
      document.documentElement.classList.toggle('light');
    });

    /* ========= NAV / SIDEBAR ========= */
    function sectionTo(name){
      $$("#sidebar .nav-link").forEach(b=>b.classList.remove("nav-active"));
      $(`[data-section="${name}"]`)?.classList.add("nav-active");
      ["feed","chat","friends","leaderboard","notifications","profile"].forEach(s=>{
        byId(`section-${s}`).classList.toggle("hidden", s!==name);
      });
      closeSidebar();
    }
    function closeSidebar(){ byId('sidebar').classList.add('-translate-x-full'); byId('overlay').classList.add('hidden'); }
    function openSidebar(){ byId('sidebar').classList.remove('-translate-x-full'); byId('overlay').classList.remove('hidden'); }
    byId("btnOpenSidebar").addEventListener("click", openSidebar);
    byId("overlay").addEventListener("click", closeSidebar);
    $$("#sidebar .nav-link").forEach(b=> b.addEventListener("click", ()=> sectionTo(b.dataset.section)));

    // Profile dropdown
    const profileToggle = byId("profileToggle");
    const profileMenu   = byId("profileMenu");
    profileToggle.addEventListener("click", ()=> profileMenu.classList.toggle("hidden"));
    document.addEventListener("click", (e)=>{ if(!profileToggle.contains(e.target) && !profileMenu.contains(e.target)) profileMenu.classList.add("hidden"); });

    /* ========= AUTH GATE ========= */
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href = "auth.html"; return; }
      me = user;
      meDoc = await ensureUserDoc(user);
      hydrateHeader();
      startFeed();
      startNotifications();
      loadSuggestions();
      loadFriendAssets();
      loadLeaderboard();
      byId("gate").classList.add("hidden");
      byId("app").classList.remove("hidden");
    });

    byId("btnLogout").addEventListener("click", ()=> signOut(auth));

    async function ensureUserDoc(user){
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, {
          uid:user.uid, email:user.email||null,
          nickname: user.displayName || ("Player_"+user.uid.slice(0,4)),
          gamer: user.displayName || null,
          avatar: user.photoURL || null,
          bio: "", status: "online",
          sex:"", dob:"", lang:"", country:"", games:"",
          privDOB:true, privEmail:true,
          points:0, rank:1, friends:[], requests:[],
          createdAt: nowTs(), lastSeen: nowTs()
        });
        return await getDoc(ref);
      }
      return snap.data();
    }

    function hydrateHeader(){
      byId("navAvatar").src = meDoc.avatar || "https://i.pravatar.cc/80?img=3";
      byId("navNick").textContent = meDoc.nickname;
      byId("navRank").textContent = meDoc.rank;
      byId("navPoints").textContent = meDoc.points;
      byId("sideAvatar").src = meDoc.avatar || "https://i.pravatar.cc/80?img=4";
      byId("sideNick").textContent = meDoc.nickname;
      byId("sidePoints").textContent = meDoc.points;
      byId("cpAvatar").src = meDoc.avatar || "https://i.pravatar.cc/80?img=5";
    }

    /* ========= FEED ========= */
    function startFeed(){
      if(feedUnsub) feedUnsub();
      const q = query(collection(db, "posts"), orderBy("createdAt","desc"), limit(10));
      feedUnsub = onSnapshot(q, snap=>{
        byId("feedList").innerHTML = "";
        snap.forEach(doc=> renderPost(doc.id, doc.data()));
      });
    }

    function renderPost(id, data){
      const div = document.createElement("div");
      div.className = "glass rounded-xl p-4";
      div.innerHTML = `
        <div class="flex items-start gap-3">
          <img class="w-10 h-10 rounded object-cover cursor-pointer" src="${data.avatar||'https://i.pravatar.cc/80?img=1'}" onclick="viewProfile('${data.uid}')">
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <div class="font-semibold">${data.gamer||data.nickname||'Player'}</div>
              <span class="text-xs text-white/50">${tsToText(data.createdAt)}</span>
              ${data.uid===me.uid ? `<button class="ml-auto text-red-400 hover:text-red-300 text-sm" onclick="deletePost('${id}')"><i class="fa-solid fa-trash"></i></button>` : ''}
            </div>
            <div class="mt-1">${md(data.text)}</div>
            ${data.image ? `<img src="${data.image}" class="mt-2 max-h-96 rounded-lg cursor-pointer" onclick="showImage('${data.image}')">` : ''}
            ${data.link ? `<div class="mt-2"><a href="${data.link}" target="_blank" class="text-[var(--mh-accent)] text-sm">${data.link}</a></div>` : ''}
            <div class="mt-3 flex items-center gap-4 text-sm text-white/60">
              <button class="reaction-btn flex items-center gap-1 hover:text-white" onclick="reactPost('${id}','like')">
                <i class="fa-regular fa-heart"></i> <span>${data.likes?.length||0}</span>
              </button>
              <button class="reaction-btn flex items-center gap-1 hover:text-white" onclick="reactPost('${id}','laugh')">
                <i class="fa-regular fa-face-laugh-beam"></i> <span>${data.laughs?.length||0}</span>
              </button>
              <button class="reaction-btn flex items-center gap-1 hover:text-white" onclick="reactPost('${id}','fire')">
                <i class="fa-solid fa-fire"></i> <span>${data.fires?.length||0}</span>
              </button>
            </div>
          </div>
        </div>
      `;
      byId("feedList").appendChild(div);
    }

    byId("btnPost").addEventListener("click", async ()=>{
      const text = byId("postText").value.trim();
      if(!text) return;
      const image = byId("postImage").files[0] ? await fileToBase64(byId("postImage").files[0]) : null;
      const link = byId("postLink").value.trim() || null;
      await addDoc(collection(db, "posts"), {
        uid: me.uid, avatar: meDoc.avatar, nickname: meDoc.nickname, gamer: meDoc.gamer,
        text, image, link, likes:[], laughs:[], fires:[],
        createdAt: nowTs()
      });
      byId("postText").value = "";
      byId("postImage").value = "";
      byId("postLink").value = "";
    });

    window.showImage = (src)=> { byId("imgLarge").src = src; byId("imgLight").classList.remove("hidden"); };
    byId("imgClose").addEventListener("click", ()=> byId("imgLight").classList.add("hidden"));

    window.deletePost = async (id)=>{
      if(confirm("Delete this post?")) await deleteDoc(doc(db, "posts", id));
    };

    window.reactPost = async (id, type)=>{
      const ref = doc(db, "posts", id);
      const snap = await getDoc(ref);
      if(!snap.exists()) return;
      const data = snap.data();
      const key = type+"s";
      const arr = data[key] || [];
      const idx = arr.indexOf(me.uid);
      if(idx>=0) arr.splice(idx,1);
      else arr.push(me.uid);
      await updateDoc(ref, { [key]: arr });
    };

    /* ========= CHAT ========= */
    async function loadChatUsers(){
      const q = query(collection(db, "users"), where("uid", "in", meDoc.friends||[]));
      const snap = await getDocs(q);
      byId("chatUsers").innerHTML = "";
      snap.forEach(doc=> renderChatUser(doc.id, doc.data()));
    }

    function renderChatUser(id, data){
      const div = document.createElement("div");
      div.className = "flex items-center gap-3 p-2 rounded hover:bg-white/10 cursor-pointer";
      div.onclick = ()=> openChat(id, data);
      div.innerHTML = `
        <img class="w-10 h-10 rounded object-cover" src="${data.avatar||'https://i.pravatar.cc/80?img=2'}">
        <div class="flex-1">
          <div class="font-semibold">${data.nickname}</div>
          <div class="text-xs text-white/50">${data.status||'offline'}</div>
        </div>
      `;
      byId("chatUsers").appendChild(div);
    }

    function openChat(uid, peerData){
      chatPeer = {uid, ...peerData};
      byId("chatPeerAvatar").src = chatPeer.avatar||'https://i.pravatar.cc/80?img=6';
      byId("chatPeerNick").textContent = chatPeer.nickname;
      byId("chatPeerStatus").textContent = chatPeer.status||'offline';
      if(chatUnsub) chatUnsub();
      const q = query(collection(db, "chats"), where("users", "array-contains", me.uid), where("users", "array-contains", uid), limit(1));
      getDocs(q).then(snap=>{
        if(snap.empty){
          addDoc(collection(db, "chats"), {
            users: [me.uid, uid], createdAt: nowTs(), messages: []
          }).then(docRef=> listenChat(docRef.id) );
        }else{
          const doc = snap.docs[0];
          listenChat(doc.id);
        }
      });
    }

    function listenChat(chatId){
      chatUnsub = onSnapshot(doc(db, "chats", chatId), snap=>{
        if(!snap.exists()) return;
        const data = snap.data();
        byId("chatStream").innerHTML = "";
        (data.messages||[]).forEach(msg=> renderMessage(msg));
        byId("chatStream").scrollTop = byId("chatStream").scrollHeight;
      });
    }

    function renderMessage(msg){
      const div = document.createElement("div");
      div.className = `flex ${msg.uid===me.uid ? 'justify-end' : 'justify-start'}`;
      div.innerHTML = `
        <div class="max-w-[75%] bg-[var(--mh-panel)] rounded-lg p-3">
          <div class="text-sm">${md(msg.text)}</div>
          <div class="text-xs text-white/40 mt-1 text-right">${tsToText(msg.ts)}</div>
        </div>
      `;
      byId("chatStream").appendChild(div);
    }

    byId("chatInput").addEventListener("keypress", e=>{ if(e.key==="Enter") sendChat(); });
    byId("btnSendChat").addEventListener("click", sendChat);

    function sendChat(){
      const text = byId("chatInput").value.trim();
      if(!text || !chatPeer) return;
      const q = query(collection(db, "chats"), where("users", "array-contains", me.uid), where("users", "array-contains", chatPeer.uid), limit(1));
      getDocs(q).then(snap=>{
        if(snap.empty) return;
        const doc = snap.docs[0];
        const msg = {uid:me.uid, text, ts: nowTs()};
        updateDoc(doc.ref, { messages: arrayUnion(msg) });
        byId("chatInput").value = "";
      });
    }

    /* ========= FRIENDS ========= */
    async function loadSuggestions(){
      const q = query(collection(db, "users"), where("uid", "not-in", [...(meDoc.friends||[]), me.uid]), limit(6));
      const snap = await getDocs(q);
      byId("friendSuggestions").innerHTML = "";
      snap.forEach(doc=> renderSuggestion(doc.id, doc.data()));
    }

    function renderSuggestion(id, data){
      const div = document.createElement("div");
      div.className = "flex items-center gap-3 p-3 glass rounded-lg";
      div.innerHTML = `
        <img class="w-12 h-12 rounded object-cover" src="${data.avatar||'https://i.pravatar.cc/80?img=7'}">
        <div class="flex-1">
          <div class="font-semibold">${data.nickname}</div>
          <div class="text-xs text-white/50">Level ${data.rank||1} · ${data.points||0} pts</div>
        </div>
        <button class="px-3 py-1.5 rounded bg-[var(--mh-primary)] hover:bg-[var(--mh-primary-2)] text-sm" onclick="sendRequest('${id}')">Add</button>
      `;
      byId("friendSuggestions").appendChild(div);
    }

    window.sendRequest = async (uid)=>{
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if(!snap.exists()) return;
      const data = snap.data();
      const requests = data.requests || [];
      if(requests.includes(me.uid)) return;
      await updateDoc(ref, { requests: arrayUnion(me.uid) });
      alert("Request sent!");
    };

    async function loadIncomingRequests(){
      const q = query(collection(db, "users"), where("requests", "array-contains", me.uid));
      const snap = await getDocs(q);
      byId("incomingRequests").innerHTML = "";
      snap.forEach(doc=> renderRequest(doc.id, doc.data()));
    }

    function renderRequest(id, data){
      const div = document.createElement("div");
      div.className = "flex items-center gap-3 p-3 glass rounded-lg";
      div.innerHTML = `
        <img class="w-10 h-10 rounded object-cover" src="${data.avatar||'https://i.pravatar.cc/80?img=8'}">
        <div class="flex-1">
          <div class="font-semibold">${data.nickname}</div>
          <div class="text-xs text-white/50">wants to be friends</div>
        </div>
        <button class="px-3 py-1.5 rounded bg-[var(--mh-ok)] hover:bg-green-600 text-sm" onclick="acceptRequest('${id}')">Accept</button>
        <button class="px-3 py-1.5 rounded bg-[var(--mh-danger)] hover:bg-red-600 text-sm" onclick="ignoreRequest('${id}')">Ignore</button>
      `;
      byId("incomingRequests").appendChild(div);
    }

    window.acceptRequest = async (uid)=>{
      // Remove from my requests, add to my friends
      const myRef = doc(db, "users", me.uid);
      await updateDoc(myRef, { friends: arrayUnion(uid), requests: arrayRemove(uid) });
      // Add me to their friends
      const theirRef = doc(db, "users", uid);
      await updateDoc(theirRef, { friends: arrayUnion(me.uid) });
      loadIncomingRequests();
      loadFriendList();
    };

    window.ignoreRequest = async (uid)=>{
      const myRef = doc(db, "users", me.uid);
      await updateDoc(myRef, { requests: arrayRemove(uid) });
      loadIncomingRequests();
    };

    async function loadFriendList(){
      const q = query(collection(db, "users"), where("uid", "in", meDoc.friends||[]));
      const snap = await getDocs(q);
      byId("friendList").innerHTML = "";
      snap.forEach(doc=> renderFriend(doc.id, doc.data()));
    }

    function renderFriend(id, data){
      const div = document.createElement("div");
      div.className = "flex items-center gap-3 p-3 glass rounded-lg";
      div.innerHTML = `
        <img class="w-12 h-12 rounded object-cover" src="${data.avatar||'https://i.pravatar.cc/80?img=9'}">
        <div class="flex-1">
          <div class="font-semibold">${data.nickname}</div>
          <div class="text-xs text-white/50">${data.status||'offline'}</div>
        </div>
        <div class="flex items-center gap-2">
          <button class="p-2 rounded hover:bg-white/10" onclick="viewProfile('${id}')"><i class="fa-solid fa-user"></i></button>
          <button class="p-2 rounded hover:bg-white/10" onclick="openChat('${id}')"><i class="fa-solid fa-message"></i></button>
        </div>
      `;
      byId("friendList").appendChild(div);
    }

    function loadFriendAssets(){
      loadChatUsers();
      loadIncomingRequests();
      loadFriendList();
    }

    /* ========= LEADERBOARD ========= */
    async function loadLeaderboard(){
      const q = query(collection(db, "users"), orderBy("points","desc"), limit(20));
      const snap = await getDocs(q);
      byId("leaderRows").innerHTML = "";
      let rank = 1;
      snap.forEach(doc=>{
        const data = doc.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="py-2 px-2">${rank++}</td>
          <td class="py-2 px-2"><img class="w-8 h-8 rounded object-cover inline mr-2" src="${data.avatar||'https://i.pravatar.cc/80?img=10'}"></td>
          <td class="py-2 px-2">${data.nickname}</td>
          <td class="py-2 px-2">${data.points||0}</td>
          <td class="py-2 px-2">${data.rank||1}</td>
        `;
        byId("leaderRows").appendChild(tr);
      });
    }

    /* ========= NOTIFICATIONS ========= */
    function startNotifications(){
      if(notifUnsub) notifUnsub();
      const q = query(collection(db, "notifications"), where("uid", "==", me.uid), orderBy("ts","desc"), limit(20));
      notifUnsub = onSnapshot(q, snap=>{
        byId("notifList").innerHTML = "";
        if(snap.empty){
          byId("notifList").innerHTML = `<div class="text-center text-white/50 py-4">No notifications yet.</div>`;
          return;
        }
        snap.forEach(doc=> renderNotification(doc.id, doc.data()));
      });
    }

    function renderNotification(id, data){
      const div = document.createElement("div");
      div.className = "p-3 glass rounded-lg";
      div.innerHTML = `
        <div class="flex items-start gap-3">
          <i class="fa-solid fa-bell text-[var(--mh-accent)] mt-1"></i>
          <div class="flex-1">
            <div>${md(data.text)}</div>
            <div class="text-xs text-white/50 mt-1">${tsToText(data.ts)}</div>
          </div>
          ${data.link ? `<a href="${data.link}" class="text-[var(--mh-primary)] hover:underline">View</a>` : ''}
        </div>
      `;
      byId("notifList").appendChild(div);
    }

    /* ========= PROFILE ========= */
    function hydrateProfile(){
      byId("setNick").value = meDoc.nickname || "";
      byId("setGamer").value = meDoc.gamer || "";
      byId("setSex").value = meDoc.sex || "";
      byId("setDOB").value = meDoc.dob || "";
      byId("setLang").value = meDoc.lang || "";
      byId("setCountry").value = meDoc.country || "";
      byId("setGames").value = meDoc.games || "";
      byId("setStatus").value = meDoc.status || "online";
      byId("setBio").value = meDoc.bio || "";
      byId("privDOB").checked = !!meDoc.privDOB;
      byId("privEmail").checked = !!meDoc.privEmail;
    }

    byId("btnSaveProfile").addEventListener("click", async ()=>{
      const data = {
        nickname: byId("setNick").value.trim(),
        gamer: byId("setGamer").value.trim(),
        sex: byId("setSex").value,
        dob: byId("setDOB").value,
        lang: byId("setLang").value.trim(),
        country: byId("setCountry").value.trim(),
        games: byId("setGames").value.trim(),
        status: byId("setStatus").value,
        bio: byId("setBio").value.trim(),
        privDOB: byId("privDOB").checked,
        privEmail: byId("privEmail").checked,
        lastSeen: nowTs()
      };
      if(byId("setAvatar").files[0]){
        data.avatar = await fileToBase64(byId("setAvatar").files[0]);
      }
      await updateDoc(doc(db, "users", me.uid), data);
      meDoc = {...meDoc, ...data};
      hydrateHeader();
      byId("profileSaved").classList.remove("hidden");
      setTimeout(()=> byId("profileSaved").classList.add("hidden"), 3000);
    });

    /* ========= ADMIN ========= */
    byId("btnAdminDeletePost").addEventListener("click", async ()=>{
      const id = byId("adminDeletePostId").value.trim();
      if(!id || !confirm("Delete post "+id+"?")) return;
      if(me.uid !== ADMIN_UID){ alert("Not admin."); return; }
      await deleteDoc(doc(db, "posts", id));
      byId("adminDeletePostId").value = "";
    });

    byId("btnBanUser").addEventListener("click", async ()=>{
      const uid = prompt("Enter UID to (soft) ban:");
      if(!uid || me.uid !== ADMIN_UID){ alert("Not admin."); return; }
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){ alert("User not found."); return; }
      const data = snap.data();
      const banned = data.banned || false;
      await updateDoc(ref, { banned: !banned });
      alert("User "+(banned?"unbanned":"banned"));
    });

    /* ========= VIEW PROFILE ========= */
    window.viewProfile = async (uid)=>{
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if(!snap.exists()) return;
      const data = snap.data();
      byId("pmAvatar").src = data.avatar||'https://i.pravatar.cc/80?img=11';
      byId("pmName").textContent = data.nickname;
      byId("pmUid").textContent = "UID: "+shortId(uid);
      byId("pmBio").textContent = data.bio || "(No bio)";
      let publicInfo = "";
      if(data.gamer) publicInfo += `Display: ${data.gamer}\n`;
      if(data.lang) publicInfo += `Language: ${data.lang}\n`;
      if(data.country) publicInfo += `Country: ${data.country}\n`;
      if(data.games) publicInfo += `Games: ${data.games}\n`;
      publicInfo += `Points: ${data.points||0} · Rank: ${data.rank||1}`;
      byId("pmPublic").textContent = publicInfo;
      byId("profileModal").classList.remove("hidden");
    };

    byId("pmClose").addEventListener("click", ()=> byId("profileModal").classList.add("hidden"));

    /* ========= INIT ========= */
    // When profile section is opened, hydrate the form
    byId("section-profile").addEventListener("click", hydrateProfile);
  </script>
</body>
  </html>

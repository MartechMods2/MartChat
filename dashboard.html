<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gamer Dashboard</title>
<style>
  body{background:linear-gradient(120deg,#1e272e,#485460);font-family:Arial,Helvetica,sans-serif;color:#fff;margin:0;padding:0}
  .wrap{max-width:900px;margin:28px auto;padding:18px;background:rgba(0,0,0,0.45);border-radius:12px}
  header{display:flex;gap:16px;align-items:center}
  img{width:100px;height:100px;border-radius:50%;object-fit:cover;border:3px solid #3498db}
  h1{margin:0}
  .cols{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
  .card{background:rgba(255,255,255,0.03);padding:12px;border-radius:8px}
  input,select,textarea,button{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:none;font-size:15px}
  textarea{height:72px;resize:none}
  .btn-green{background:#27ae60;color:#fff;cursor:pointer}
  .btn-red{background:#e74c3c;color:#fff;cursor:pointer}
  ol,ul{padding-left:18px}
  .badge{display:flex;align-items:center;gap:8px;margin-bottom:5px}
  .badge img{width:20px;height:20px;object-fit:cover;border-radius:3px}
  #chatMessages{height:200px;overflow-y:auto;background:rgba(0,0,0,0.2);padding:8px;border-radius:6px;font-size:14px}
  @media(max-width:900px){.cols{grid-template-columns:1fr}}
</style>
</head>
<body>

<div class="wrap">
  <header>
    <img id="profilePic" src="https://via.placeholder.com/100" alt="profile"/>
    <div>
      <h1 id="displayName">Loading...</h1>
      <div id="email" style="opacity:0.9"></div>
    </div>
  </header>

  <div class="cols">
    <div>
      <div class="card">
        <h3>Gamer Info</h3>
        <input id="nickname" placeholder="Gamer Nickname"/>
        <select id="rank">
          <option value="">Select rank</option><option>Rookie</option><option>Pro</option><option>Elite</option><option>Legend</option>
        </select>
        <input id="points" type="number" placeholder="Points" readonly/>
        <textarea id="bio" placeholder="Bio (short)"></textarea>
        <input id="favGame" placeholder="Favorite Game"/>
        <button class="btn-green" onclick="saveGamerFields()">Save gamer info</button>
      </div>

      <div class="card">
        <h3>Recent Games</h3>
        <ul id="gamesList"></ul>
        <input id="newGame" placeholder="Game name"/>
        <button class="btn-green" onclick="addGame()">Add game</button>
      </div>

      <div class="card">
        <h3>Achievements</h3>
        <div id="achievementsList"></div>
        <input id="newAchievement" placeholder="New achievement name"/>
        <input id="badgeUrl" placeholder="Badge image URL (optional)"/>
        <button class="btn-green" onclick="addAchievement()">Add achievement</button>
      </div>
    </div>

    <aside>
      <div class="card">
        <h3>Leaderboard (Top 5)</h3>
        <ol id="leaderboard"></ol>
      </div>

      <div class="card">
        <h3>Global Chat</h3>
        <div id="chatMessages"></div>
        <input id="chatInput" placeholder="Type a message..."/>
        <button class="btn-green" onclick="sendChat()">Send</button>
      </div>

      <div class="card">
        <h3>Quick Actions</h3>
        <button onclick="addPoints(10)" class="btn-green">+10 Points</button>
        <button onclick="addPoints(100)" class="btn-green">+100 Points</button>
        <button onclick="claimDailyBonus()" class="btn-green">Daily Bonus</button>
        <button onclick="logout()" class="btn-red">Logout</button>
      </div>
    </aside>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAgx0jy6we6cvnIgKbS1fBoeRfSD2MDszo",
  authDomain: "mod-hive.firebaseapp.com",
  projectId: "mod-hive",
  storageBucket: "mod-hive.firebasestorage.app",
  messagingSenderId: "982583858832",
  appId: "1:982583858832:web:44d5e4e2edd77fac06ea15",
  measurementId: "G-PK2DRED7FB"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let uid = null;

// === AUTH STATE ===
auth.onAuthStateChanged(user => {
  if (!user) { window.location.href = "auth.html"; return; }
  uid = user.uid;
  document.getElementById('displayName').textContent = user.displayName || "Player";
  document.getElementById('profilePic').src = user.photoURL || "https://via.placeholder.com/100";
  document.getElementById('email').textContent = user.email || "";

  // Load own profile
  db.collection('users').doc(uid).onSnapshot(doc => {
    if (!doc.exists) return;
    const d = doc.data();
    document.getElementById('nickname').value = d.nickname || "";
    document.getElementById('rank').value = d.rank || "";
    document.getElementById('points').value = d.points || 0;
    document.getElementById('bio').value = d.bio || "";
    document.getElementById('favGame').value = d.favGame || "";
    renderAchievements(d.achievements || []);
    renderList('gamesList', d.recentGames || []);
  });

  // Leaderboard
  db.collection('users').orderBy('points','desc').limit(5).onSnapshot(snap => {
    const el = document.getElementById('leaderboard'); el.innerHTML='';
    snap.forEach(doc => {
      const r = doc.data();
      const name = r.nickname || (r.email? r.email.split('@')[0] : 'Unknown');
      el.innerHTML += `<li>${escapeHtml(name)} â€” ${Number(r.points||0)} pts</li>`;
    });
  });

  // Chat
  db.collection('chat').orderBy('timestamp','asc').limitToLast(50).onSnapshot(snap => {
    const chatBox = document.getElementById('chatMessages');
    chatBox.innerHTML = '';
    snap.forEach(doc => {
      const msg = doc.data();
      const time = msg.timestamp?.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) || '';
      chatBox.innerHTML += `<div><strong>${escapeHtml(msg.nickname || 'Player')}</strong> <small>${time}</small>: ${escapeHtml(msg.text)}</div>`;
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  });
});

// === UTILITIES ===
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function renderList(elId, arr){ const el = document.getElementById(elId); el.innerHTML=''; (arr||[]).forEach(item=> el.innerHTML += `<li>${escapeHtml(item)}</li>`); }
function renderAchievements(arr){
  const el = document.getElementById('achievementsList');
  el.innerHTML='';
  arr.forEach(obj => {
    if (typeof obj === 'string') obj = { name: obj, badge: '' };
    el.innerHTML += `<div class="badge">${obj.badge? `<img src="${escapeHtml(obj.badge)}"/>` : ''} ${escapeHtml(obj.name)}</div>`;
  });
}
function getRankFromPoints(points){
  if (points >= 1000) return "Legend";
  if (points >= 500) return "Elite";
  if (points >= 100) return "Pro";
  return "Rookie";
}

// === PROFILE ACTIONS ===
function saveGamerFields(){
  if (!uid) return;
  const points = parseInt(document.getElementById('points').value) || 0;
  const rank = getRankFromPoints(points);
  db.collection('users').doc(uid).set({
    nickname: document.getElementById('nickname').value.trim() || "New Gamer",
    rank: rank,
    points: points,
    bio: document.getElementById('bio').value || "",
    favGame: document.getElementById('favGame').value || ""
  }, { merge: true }).then(()=> alert('Gamer info saved.'));
}

function addAchievement(){
  const name = document.getElementById('newAchievement').value.trim();
  const badge = document.getElementById('badgeUrl').value.trim();
  if (!name || !uid) return;
  db.collection('users').doc(uid).update({ achievements: firebase.firestore.FieldValue.arrayUnion({ name: name, badge: badge }) })
    .then(()=> { document.getElementById('newAchievement').value=''; document.getElementById('badgeUrl').value=''; });
}

function addGame(){
  const g = document.getElementById('newGame').value.trim();
  if (!g || !uid) return;
  db.collection('users').doc(uid).update({ recentGames: firebase.firestore.FieldValue.arrayUnion(g) })
    .then(()=> document.getElementById('newGame').value='');
}

function addPoints(n){
  if (!uid) return;
  const ref = db.collection('users').doc(uid);
  db.runTransaction(tx => {
    return tx.get(ref).then(doc=>{
      const current = (doc.exists && doc.data().points) ? doc.data().points : 0;
      const newPoints = current + n;
      tx.set(ref, { points: newPoints, rank: getRankFromPoints(newPoints) }, { merge: true });
    });
  });
}

function claimDailyBonus(){
  if (!uid) return;
  const ref = db.collection('users').doc(uid);
  db.runTransaction(tx => {
    return tx.get(ref).then(doc=>{
      const data = doc.data() || {};
      const lastClaim = data.lastBonusClaim ? new Date(data.lastBonusClaim) : null;
      const today = new Date(); today.setHours(0,0,0,0);
      if (lastClaim && lastClaim >= today){
        alert("You already claimed today's bonus!");
        return;
      }
      const newPoints = (data.points || 0) + 50;
      tx.set(ref, { points: newPoints, rank: getRankFromPoints(newPoints), lastBonusClaim: firebase.firestore.Timestamp.fromDate(new Date()) }, { merge: true });
    });
  }).then(()=> alert("Daily bonus claimed! +50 points"));
}

// === CHAT ===
function sendChat(){
  const text = document.getElementById('chatInput').value.trim();
  if (!text || !uid) return;
  db.collection('users').doc(uid).get().then(userDoc => {
    const data = userDoc.data() || {};
    const nickname = data.nickname || auth.currentUser.displayName || "Player";
    db.collection('chat').add({
      nickname: nickname,
      text: text,
      timestamp: firebase.firestore.Timestamp.fromDate(new Date())
    }).then(() => {
      document.getElementById('chatInput').value = '';
    });
  });
}

// === LOGOUT ===
function logout(){ auth.signOut().then(()=> location.href='auth.html'); }
</script>
<style>
      
    p {
        font-size: 16px;
        opacity: 0;
        transition: opacity 1s ease-in-out;
    }
    button {
        padding: 10px 20px;
        background: #e74c3c;
        border: none;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 20px;
        font-size: 16px;
        opacity: 0;
        transition: opacity 1s ease-in-out;
    }
    button:hover {
        background: #c0392b;
    }
    .visible {
        opacity: 1 !important;
    }
</style>

<div class="container">
    <h1 id="greeting"></h1>
    <img id="userPhoto" src="" alt="User Photo">
    <p id="userEmail"></p>
    <button onclick="logout()" id="logoutBtn">Logout</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script>
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAgx0jy6we6cvnIgKbS1fBoeRfSD2MDszo",
  authDomain: "mod-hive.firebaseapp.com",
  projectId: "mod-hive",
  storageBucket: "mod-hive.firebasestorage.app",
  messagingSenderId: "982583858832",
  appId: "1:982583858832:web:44d5e4e2edd77fac06ea15",
  measurementId: "G-PK2DRED7FB"
};
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    function typeWriterEffect(element, text, speed = 100, callback) {
        let i = 0;
        element.textContent = "";
        function typing() {
            if (i < text.length) {
                element.textContent += text.charAt(i);
                i++;
                setTimeout(typing, speed);
            } else if (callback) {
                callback();
            }
        }
        typing();
    }

    auth.onAuthStateChanged(user => {
        if (!user) {
            window.location.href = "auth.html";
        } else {
            let firstName = "User";
            if (user.displayName) {
                firstName = user.displayName.split(" ")[0];
            } else if (user.email) {
                firstName = user.email.split("@")[0];
            }

            typeWriterEffect(document.getElementById('greeting'), `Welcome, ${firstName}`, 80, () => {
                document.getElementById('userPhoto').classList.add('visible');
                document.getElementById('userEmail').classList.add('visible');
                document.getElementById('logoutBtn').classList.add('visible');
            });

            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userPhoto').src = user.photoURL || "https://via.placeholder.com/100";
        }
    });

    function logout() {
        auth.signOut().then(() => {
            window.location.href = "auth.html";
        });
    }
</script>
</body>
</html>

<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mod Hive ‚Äî Dashboard (Mobile-first, fixed)</title>

  <!-- Tailwind via CDN (quick) and FontAwesome -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --primary:#6c5ce7; --primary-2:#5649c0; --accent:#00cec9;
      --bg:#0b0f13; --panel:#111317; --muted:#93a1b1; --ok:#10b981; --danger:#ef4444;
    }
    html,body{height:100%; background:var(--bg); color:#e8eef6; font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .glass{background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.04); backdrop-filter: blur(6px);}
    .toast-enter{animation:toastIn .18s ease forwards} @keyframes toastIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}
    .hidden-el{display:none!important}
    .spinner{width:22px;height:22px;border-radius:999px;border:3px solid rgba(255,255,255,.12);border-top-color:var(--primary);animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .clickable{cursor:pointer}
    /* mobile-first grid */
    .layout { display:grid; grid-template-columns: 1fr; gap:12px; padding:12px; max-width:1100px; margin:0 auto; }
    @media(min-width:900px){ .layout { grid-template-columns: 260px 1fr 320px; padding:20px } }
    .card { border-radius:12px; padding:12px }
    .tiny { font-size:12px }
    /* small helpers */
    .muted { color:var(--muted) }
    .btn { transition: transform .08s ease }
    .btn:active{ transform: scale(.985) }
    /* Image viewer */
    #imgViewer { position:fixed; inset:0; background:rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; z-index:60 }
    #imgViewer img{ max-width:96vw; max-height:86vh; border-radius:10px }
    /* bottom tab (mobile) */
    .bottom-tab { position:fixed; inset-inline:0; bottom:0; z-index:55; background:var(--panel); border-top:1px solid rgba(255,255,255,.03); display:flex }
    .bottom-tab button{ flex:1; padding:10px 0; text-align:center; color:#cde0ff88 }
    .active-tab{ color:#fff }
    /* comment box hidden by default */
    .comments-hidden { display:none }
    /* adaptive img thumb */
    .img-thumb { width:100%; max-height:380px; object-fit:cover; border-radius:10px; cursor:zoom-in }
    /* responsive post text collapse */
    .post-text { white-space:pre-wrap; word-break:break-word }
    /* menu */
    .menu { position:absolute; right:8px; top:36px; min-width:160px; display:none }
    .menu.show { display:block }
  </style>
</head>
<body class="min-h-screen">

<!-- AUTH GATE: spinner while auth is checked -->
<div id="gate" class="fixed inset-0 z-60 flex items-center justify-center bg-[var(--bg)]/95">
  <div class="glass p-6 rounded-lg text-center w-11/12 max-w-sm">
    <div class="mx-auto mb-3 spinner"></div>
    <h2 class="text-lg font-semibold">Mod Hive</h2>
    <p class="muted tiny mt-2">Checking your session ‚Äî please wait...</p>
  </div>
</div>

<!-- Image viewer modal -->
<div id="imgViewer" class="">
  <button id="imgClose" class="absolute top-4 right-4 p-2 rounded bg-white/10"><i class="fa fa-times"></i></button>
  <img id="imgLarge" src="" alt=""/>
</div>

<!-- Confirm modal (custom) -->
<div id="confirmModal" class="fixed inset-0 z-70 hidden items-center justify-center bg-black/60">
  <div class="glass p-4 rounded-lg max-w-sm w-11/12">
    <h3 id="confirmTitle" class="font-semibold">Confirm</h3>
    <p id="confirmText" class="muted tiny mt-1">Are you sure?</p>
    <div class="mt-4 flex justify-end gap-2">
      <button id="confirmCancel" class="px-3 py-1 rounded bg-white/10">Cancel</button>
      <button id="confirmOk" class="px-3 py-1 rounded bg-[var(--danger)] text-white">OK</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toasts" class="fixed right-4 bottom-24 z-80 space-y-2"></div>

<!-- APP -->
<div id="app" class="hidden">

  <!-- Topbar -->
  <header class="glass w-full border-b border-white/5 py-3 px-3 flex items-center justify-between sticky top-0 z-40">
    <div class="flex items-center gap-3">
      <div id="burger" class="md:hidden p-2 rounded bg-white/5 clickable"><i class="fa fa-bars"></i></div>
      <div class="inline-flex items-center gap-2">
        <div id="logo" class="w-8 h-8 rounded bg-[var(--primary)] flex items-center justify-center text-white font-bold">MH</div>
        <div><div class="font-semibold">Mod Hive</div><div class="tiny muted">Gaming Social</div></div>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <div id="searchBoxWrap" class="hidden md:flex items-center bg-[var(--panel)] rounded px-2 py-1">
        <i class="fa fa-search text-white/60 mr-2"></i>
        <input id="searchBox" placeholder="Search posts or users..." class="bg-transparent outline-none text-sm w-64 text-white/80"/>
      </div>
      <button id="notifBtn" class="p-2 rounded bg-white/5 clickable relative"><i class="fa-regular fa-bell"></i><span id="notifDot" class="absolute -top-1 -right-1 w-2 h-2 rounded-full bg-[var(--danger)] hidden"></span></button>
      <div class="relative">
        <button id="profileBtn" class="flex items-center gap-2 px-2 py-1 rounded bg-white/5 clickable">
          <img id="navAvatar" class="w-8 h-8 rounded object-cover" src="" alt="avatar"/>
          <span id="navNick" class="hidden md:inline tiny">Player</span>
        </button>
        <div id="profileMenu" class="menu glass rounded shadow p-2">
          <button data-section="profile" class="w-full text-left px-2 py-2 rounded hover:bg-white/5">Profile</button>
          <button data-section="notifications" class="w-full text-left px-2 py-2 rounded hover:bg-white/5">Notifications</button>
          <button id="btnLogout" class="w-full text-left px-2 py-2 rounded hover:bg-white/5 text-red-400">Sign out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main layout (mobile-first) -->
  <main class="layout">

    <!-- LEFT column: quick profile + nav (collapses on mobile) -->
    <aside class="space-y-3">
      <div class="glass card flex items-center gap-3">
        <img id="sideAvatar" class="w-12 h-12 rounded object-cover" src="" alt="avatar">
        <div>
          <div id="sideNick" class="font-semibold">Player</div>
          <div class="tiny muted">Lv <span id="sideRank">1</span> ¬∑ <span id="sidePoints">0</span> pts</div>
        </div>
      </div>

      <nav class="glass card space-y-1 p-2 hidden md:block">
        <button data-section="feed" class="w-full text-left px-3 py-2 rounded flex items-center gap-2 navbtn active"><i class="fa fa-house"></i> Feed</button>
        <button data-section="chat" class="w-full text-left px-3 py-2 rounded flex items-center gap-2 navbtn"><i class="fa fa-message"></i> Chat</button>
        <button data-section="friends" class="w-full text-left px-3 py-2 rounded flex items-center gap-2 navbtn"><i class="fa fa-user-group"></i> Friends</button>
        <button data-section="leaderboard" class="w-full text-left px-3 py-2 rounded flex items-center gap-2 navbtn"><i class="fa fa-trophy"></i> Leaderboard</button>
        <button data-section="notifications" class="w-full text-left px-3 py-2 rounded flex items-center gap-2 navbtn"><i class="fa fa-bell"></i> Notifications</button>
        <button data-section="profile" class="w-full text-left px-3 py-2 rounded flex items-center gap-2 navbtn"><i class="fa fa-id-card"></i> Profile</button>
        <a href="main.html" class="w-full text-left px-3 py-2 rounded flex items-center gap-2 hover:bg-white/5"><i class="fa fa-rotate-left"></i> Back to main</a>
      </nav>

      <!-- friend suggestions (mobile & desktop) -->
      <div id="friendSuggestionsCard" class="glass card">
        <div class="flex items-center justify-between">
          <div class="font-semibold">Suggestions</div>
          <button id="refreshSuggestions" class="tiny muted">Refresh</button>
        </div>
        <div id="friendSuggestions" class="mt-2 grid grid-cols-3 gap-2"></div>
      </div>

      <!-- admin box: rendered only when admin flag true in JS -->
      <div id="adminCard" class="glass card hidden">
        <div class="font-semibold text-red-300">Admin tools</div>
        <input id="adminDeletePostId" class="mt-2 w-full bg-[var(--panel)] p-2 rounded tiny" placeholder="Post ID to delete"/>
        <div class="mt-2 flex gap-2">
          <button id="btnAdminDeletePost" class="bg-red-500 px-3 py-1 rounded">Delete</button>
        </div>
      </div>
    </aside>

    <!-- CENTER column: main feed / chat / etc -->
    <section class="space-y-3">

      <!-- FEED -->
      <div id="section-feed" class="space-y-3">
        <div class="glass card">
          <div class="flex gap-3">
            <img id="cpAvatar" class="w-10 h-10 rounded object-cover" src="" alt="">
            <div class="flex-1">
              <textarea id="postText" rows="2" class="w-full bg-transparent outline-none resize-none text-sm" placeholder="Share something ‚Äî images and links supported"></textarea>
              <div class="mt-2 flex items-center gap-2 flex-wrap">
                <label class="px-3 py-1 bg-white/5 rounded clickable"><i class="fa-regular fa-image mr-2"></i><span class="tiny">Image</span><input id="postImage" class="hidden" type="file" accept="image/*"></label>
                <div class="flex items-center bg-[var(--panel)] rounded px-2 py-1">
                  <i class="fa fa-link text-white/50 mr-2"></i>
                  <input id="postLink" class="bg-transparent outline-none text-sm w-36" placeholder="Optional link"/>
                </div>
                <button id="btnPost" class="ml-auto px-3 py-1 bg-[var(--primary)] rounded btn">Post</button>
              </div>
            </div>
          </div>
        </div>

        <!-- feed list -->
        <div id="feedList" class="space-y-3"></div>
        <div class="flex justify-center"><button id="btnLoadMore" class="hidden px-4 py-2 glass rounded">Load more</button></div>
      </div>

      <!-- CHAT -->
      <div id="section-chat" class="hidden space-y-3">
        <div class="glass card p-3">
          <div class="font-semibold">Private Chats</div>
          <input id="chatSearch" class="mt-2 w-full bg-[var(--panel)] p-2 rounded tiny" placeholder="Find friend...">
          <div id="chatUsers" class="mt-2 space-y-2 max-h-[60vh] overflow-auto"></div>
        </div>

        <div class="glass card p-3">
          <div class="flex items-center gap-3 justify-between">
            <div class="flex items-center gap-3">
              <img id="chatPeerAvatar" class="w-10 h-10 rounded object-cover" src="" alt="">
              <div>
                <div id="chatPeerNick" class="font-semibold tiny">Select a friend</div>
                <div id="chatPeerStatus" class="muted tiny">‚Äî</div>
              </div>
            </div>
            <div class="tiny muted">Encrypted</div>
          </div>

          <div id="chatStream" class="mt-3 max-h-[44vh] overflow-auto space-y-2"></div>

          <div class="mt-3 flex gap-2">
            <button id="btnEmoji" class="px-2 py-1 bg-white/5 rounded"><i class="fa-regular fa-face-smile"></i></button>
            <input id="chatInput" class="flex-1 bg-[var(--panel)] p-2 rounded tiny" placeholder="Type message (Enter to send)"/>
            <button id="btnSendChat" class="px-3 py-1 bg-[var(--primary)] rounded"><i class="fa fa-paper-plane"></i></button>
          </div>
          <div id="emojiBar" class="mt-2 hidden flex gap-2 flex-wrap">
            <button class="px-2 py-1 bg-white/5 rounded tiny em">üòÄ</button>
            <button class="px-2 py-1 bg-white/5 rounded tiny em">üòÇ</button>
            <button class="px-2 py-1 bg-white/5 rounded tiny em">üî•</button>
            <button class="px-2 py-1 bg-white/5 rounded tiny em">üëç</button>
            <button class="px-2 py-1 bg-white/5 rounded tiny em">üòé</button>
            <button class="px-2 py-1 bg-white/5 rounded tiny em">üéÆ</button>
          </div>
        </div>
      </div>

      <!-- FRIENDS -->
      <div id="section-friends" class="hidden space-y-3">
        <div class="glass card p-3">
          <div class="font-semibold">Incoming Requests</div>
          <div id="incomingRequests" class="mt-2 space-y-2"></div>
        </div>

        <div class="glass card p-3">
          <div class="font-semibold">Your Friends</div>
          <div id="friendList" class="mt-2 grid grid-cols-2 gap-2"></div>
        </div>
      </div>

      <!-- LEADERBOARD -->
      <div id="section-leaderboard" class="hidden space-y-3">
        <div class="glass card p-3">
          <div class="font-semibold">Top Players</div>
          <div class="mt-2 overflow-auto">
            <table class="w-full tiny">
              <thead class="muted text-left"><tr><th>#</th><th>Player</th><th>Nick</th><th>Points</th><th>Rank</th></tr></thead>
              <tbody id="leaderRows"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- NOTIFICATIONS -->
      <div id="section-notifications" class="hidden space-y-3">
        <div class="glass card p-3">
          <div class="flex justify-between items-center">
            <div class="font-semibold">Notifications</div>
            <button id="btnClearSeen" class="tiny muted">Mark all read</button>
          </div>
          <div id="notifList" class="mt-2 space-y-2"></div>
        </div>
      </div>

      <!-- PROFILE -->
      <div id="section-profile" class="hidden space-y-3">
        <div class="glass card p-3">
          <div class="flex items-center gap-3">
            <img id="pvAvatar" class="w-16 h-16 rounded object-cover" src="" alt="">
            <div>
              <div id="pvNick" class="font-semibold">Player</div>
              <div class="tiny muted">Lv <span id="pvRank">1</span> ¬∑ <span id="pvPoints">0</span> pts</div>
            </div>
          </div>

          <div id="profileView" class="mt-3 hidden">
            <div id="pvBio" class="muted tiny"></div>
            <div class="mt-3 grid grid-cols-2 gap-2 tiny muted">
              <div>Gamer name: <span id="pvGamer"></span></div>
              <div>Sex: <span id="pvSex"></span></div>
              <div>DOB: <span id="pvDob"></span></div>
              <div>Lang: <span id="pvLang"></span></div>
              <div>Country: <span id="pvCountry"></span></div>
              <div>Games: <span id="pvGames"></span></div>
            </div>
            <div class="mt-3"><button id="btnEditProfile" class="px-3 py-1 bg-white/5 rounded tiny">Edit Profile</button></div>
          </div>

          <div id="profileEdit" class="mt-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <input id="setNick" placeholder="Nickname" class="bg-[var(--panel)] p-2 rounded tiny"/>
              <input id="setGamer" placeholder="Gamer display name" class="bg-[var(--panel)] p-2 rounded tiny"/>
              <select id="setSex" class="bg-[var(--panel)] p-2 rounded tiny">
                <option value="">Prefer not to say</option><option>Male</option><option>Female</option><option>Other</option>
              </select>
              <input id="setDob" type="date" class="bg-[var(--panel)] p-2 rounded tiny"/>
              <input id="setLang" placeholder="Language" class="bg-[var(--panel)] p-2 rounded tiny"/>
              <input id="setCountry" placeholder="Country" class="bg-[var(--panel)] p-2 rounded tiny"/>
              <input id="setGames" placeholder="Games (comma separated)" class="bg-[var(--panel)] p-2 rounded tiny sm:col-span-2"/>
              <input id="setAvatar" type="file" accept="image/*" class="tiny sm:col-span-2"/>
              <textarea id="setBio" rows="3" placeholder="Bio" class="bg-[var(--panel)] p-2 rounded tiny sm:col-span-2"></textarea>
            </div>
            <div class="mt-3 flex gap-2">
              <button id="btnSaveProfile" class="px-3 py-1 bg-[var(--primary)] rounded">Save</button>
              <span id="profileSaved" class="hidden tiny text-[var(--ok)]">Saved ‚úì</span>
            </div>
          </div>
        </div>
      </div>

    </section>

    <!-- RIGHT column: activity / trending (collapses on mobile) -->
    <aside class="space-y-3 hidden md:block">
      <div class="glass card p-3">
        <div class="font-semibold">Trending Games</div>
        <div class="mt-2 grid gap-2">
          <div class="p-2 bg-white/5 rounded tiny">Valorant</div>
          <div class="p-2 bg-white/5 rounded tiny">Skyrim</div>
          <div class="p-2 bg-white/5 rounded tiny">Minecraft</div>
        </div>
      </div>

      <div class="glass card p-3">
        <div class="font-semibold">Online Friends</div>
        <div id="onlineFriends" class="mt-2 space-y-2 tiny muted"></div>
      </div>
    </aside>

  </main>

  <!-- bottom nav (mobile) -->
  <div class="bottom-tab md:hidden">
    <button data-section="feed" class="tab active"> <i class="fa fa-house"></i> </button>
    <button data-section="chat" class="tab"> <i class="fa fa-message"></i> </button>
    <button data-section="friends" class="tab"> <i class="fa fa-user-group"></i> </button>
    <button data-section="leaderboard" class="tab"> <i class="fa fa-trophy"></i> </button>
    <button data-section="profile" class="tab"> <i class="fa fa-id-card"></i> </button>
  </div>

</div>

<!-- Firebase SDK (module) -->
<script type="module">
/* =========================
   FIREBASE + APP BOOTSTRAP
   ========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, serverTimestamp,
  onSnapshot, query, where, orderBy, limit, startAfter, getDocs, deleteDoc, increment, runTransaction
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAgx0jy6we6cvnIgKbS1fBoeRfSD2MDszo",
  authDomain: "mod-hive.firebaseapp.com",
  projectId: "mod-hive",
  storageBucket: "mod-hive.firebasestorage.app",
  messagingSenderId: "982583858832",
  appId: "1:982583858832:web:44d5e4e2edd77fac06ea15",
  measurementId: "G-PK2DRED7FB"
};
const ADMIN_UID = "7aTPZ6wEIpQaPjlXWDrz5Ajc4By1";
/* ========================================================== */

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ========= STATE ========= */
let me = null;            // firebase auth user
let meDoc = null;         // cached user doc
let unsubscribers = {};   // hold unsubscribe functions for named listeners
let feedCursor = null;    // pagination cursor
let chatUnsub = null;
let currentChatCid = null;
let pendingImgBase64 = null;
let authChecked = false;  // prevents redirect loops

/* ========= DOM helpers ========= */
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
const byId = (id)=>document.getElementById(id);

/* ========= UTILITIES ========= */
/* Create neutral initials avatar (canvas -> dataURL) */
function initialsAvatar(name="Player", size=128){
  const initials = (name.trim().split(/\s+/).map(p=>p[0]||"").join("").slice(0,2) || "P").toUpperCase();
  const colors = ["#6c5ce7","#00cec9","#fd79a8","#0984e3","#00b894","#e17055","#e84393"];
  const bg = colors[(initials.charCodeAt(0)+initials.length)%colors.length] || "#6c5ce7";
  const c = document.createElement('canvas'); c.width=c.height=size;
  const ctx = c.getContext('2d');
  ctx.fillStyle = bg; ctx.fillRect(0,0,size,size);
  ctx.fillStyle = "#fff"; ctx.font = `${Math.round(size*0.45)}px sans-serif`;
  ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(initials, size/2, size/2);
  return c.toDataURL('image/png');
}

function toast(message, type="info"){
  const wrap = byId('toasts');
  const el = document.createElement('div');
  el.className = 'glass px-3 py-2 rounded flex items-center gap-3 toast-enter';
  el.style.minWidth = '200px';
  el.innerHTML = `${type==="ok"?"<i class='fa fa-check text-[var(--ok)]'></i>": type==="error"?"<i class='fa fa-triangle-exclamation text-[var(--danger)]'></i>":"<i class='fa fa-bell'></i>"}<div class="flex-1">${message}</div>`;
  wrap.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(8px)'; setTimeout(()=>el.remove(),220); }, 2600);
  return el;
}

function confirmDialog(title, text){
  return new Promise(resolve=>{
    byId('confirmTitle').textContent = title;
    byId('confirmText').textContent = text;
    const modal = byId('confirmModal'); modal.style.display='flex';
    const ok = byId('confirmOk'), cancel = byId('confirmCancel');
    const clean = ()=>{ modal.style.display='none'; ok.onclick = cancel.onclick = null; };
    ok.onclick = ()=>{ clean(); resolve(true); };
    cancel.onclick = ()=>{ clean(); resolve(false); };
  });
}

async function fileToBase64(file, maxW=1200, quality=0.82){
  return new Promise((res,rej)=>{
    const reader = new FileReader();
    reader.onload = (e)=>{
      const img = new Image();
      img.onload = ()=>{
        let scale = Math.min(1, maxW / img.width);
        const w = Math.round(img.width*scale);
        const h = Math.round(img.height*scale);
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0,w,h);
        res(canvas.toDataURL('image/jpeg', quality));
      };
      img.onerror = rej;
      img.src = e.target.result;
    };
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
}

function tsToText(ts){
  try { return ts?.toDate ? ts.toDate().toLocaleString() : new Date(ts).toLocaleString(); }
  catch(e){ return "just now"; }
}

/* ========= AUTH GATE (prevents redirect loops) ========= */
onAuthStateChanged(auth, async (user)=>{
  if(authChecked && !user){
    // If we already checked and there's no user, send to auth.html
    location.href = "auth.html";
    return;
  }
  authChecked = true;
  if(!user){
    location.href = "auth.html";
    return;
  }
  me = user;
  await ensureUserDoc(user);
  await loadInitialUI();
});

/* Ensure user doc exists and hydrate meDoc */
async function ensureUserDoc(user){
  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    const nickname = user.displayName || ("Player_"+user.uid.slice(0,4));
    await setDoc(ref, {
      uid: user.uid,
      nickname,
      gamerName: nickname,
      avatar: initialsAvatar(nickname),
      bio: "", sex:"", dob:"", language:"", country:"", games:"",
      points: 0, status: "online", createdAt: serverTimestamp(), updatedAt: serverTimestamp()
    });
    meDoc = (await getDoc(ref)).data();
  } else {
    meDoc = snap.data();
    // if avatar missing, create initials
    if(!meDoc.avatar){
      await updateDoc(ref, { avatar: initialsAvatar(meDoc.nickname||"Player") });
      meDoc = (await getDoc(ref)).data();
    }
  }
}

/* ========= UI hydration after login ========= */
async function loadInitialUI(){
  // hide gate
  byId('gate').style.display = 'none';
  byId('app').classList.remove('hidden');

  // header
  const fallback = initialsAvatar(meDoc.nickname||"Player");
  for(const id of ['navAvatar','cpAvatar','sideAvatar','pvAvatar']) {
    const el = byId(id);
    if(el) el.src = meDoc.avatar || fallback;
  }
  byId('navNick').textContent = meDoc.nickname || "Player";
  byId('sideNick').textContent = meDoc.nickname || "Player";
  byId('sidePoints').textContent = meDoc.points||0;
  byId('sideRank').textContent = rankFromPoints(meDoc.points||0);
  byId('pvNick').textContent = meDoc.nickname||"Player";
  byId('pvPoints').textContent = meDoc.points||0;

  // admin UI
  if(me.uid === ADMIN_UID){
    byId('adminCard').classList.remove('hidden');
  } else {
    byId('adminCard').classList.add('hidden');
  }

  // connect listeners
  bindUIEvents();
  startFeed();           // live feed
  startNotifications();  // live notifications
  loadSuggestions();     // once
  loadFriendAssets();    // live
  loadLeaderboard();     // live
  preloadProfileViewOrEdit();

  // show initial section
  showSection('feed');
}

/* quick ranking */
function rankFromPoints(p=0){
  if(p>2000) return 10; if(p>1000) return 9; if(p>600) return 8; if(p>400) return 7;
  if(p>250) return 6; if(p>150) return 5; if(p>90) return 4; if(p>50) return 3; if(p>20) return 2;
  return 1;
}

/* ========= BIND UI INTERACTIONS ========= */
function bindUIEvents(){
  // profile menu toggle
  byId('profileBtn').addEventListener('click', (e)=>{ byId('profileMenu').classList.toggle('show'); });
  document.addEventListener('click', (e)=>{ if(!byId('profileBtn').contains(e.target) && !byId('profileMenu').contains(e.target)) byId('profileMenu').classList.remove('show'); });

  // nav (desktop)
  $$('.navbtn').forEach(btn=> btn.addEventListener('click', ()=> showSection(btn.dataset.section)));
  // bottom tabs (mobile)
  $$('.tab').forEach(t=> t.addEventListener('click', ()=> { showSection(t.dataset.section); $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); }));

  // search
  byId('searchBox')?.addEventListener('input', (e)=> {
    const q = e.target.value.trim().toLowerCase();
    // simple client-side filter
    for(const card of byId('feedList').children){
      card.style.display = card.textContent.toLowerCase().includes(q) ? '' : 'none';
    }
  });

  // post image preview -> convert to base64 (we use base64 storage because you said no paid storage)
  byId('postImage')?.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if(!f) { pendingImgBase64 = null; return; }
    // limit file size client side
    if(f.size > 5*1024*1024){ toast("Image too large (max 5MB)", "error"); e.target.value=""; pendingImgBase64=null; return; }
    try{
      pendingImgBase64 = await fileToBase64(f, 1200, .82);
      toast("Image ready");
    }catch(err){ console.error(err); toast("Failed to process image", "error"); pendingImgBase64=null; }
  });

  // create post
  byId('btnPost').addEventListener('click', createPost);

  // image viewer
  byId('imgClose').addEventListener('click', ()=> { byId('imgViewer').style.display='none'; byId('imgLarge').src=''; });

  // post interactions are delegated (renderPost adds event listeners per post but we also add a global click guard)
  document.addEventListener('click', (e)=> {
    // close any menus
    if(!e.target.closest('.menu') && !e.target.closest('[data-more]')) {
      $$('.menu').forEach(m=>m.classList.remove('show'));
    }
  });

  // chat controls
  byId('btnSendChat').addEventListener('click', sendChat);
  byId('chatInput').addEventListener('keydown', (e)=> { if(e.key==='Enter') sendChat(); });
  byId('btnEmoji').addEventListener('click', ()=> byId('emojiBar').classList.toggle('hidden'));
  $$('.em').forEach(b=> b.addEventListener('click', ()=> { byId('chatInput').value += b.textContent; byId('chatInput').focus(); }));

  // profile menu actions
  byId('profileMenu').querySelectorAll('button[data-section]').forEach(b=> b.addEventListener('click', ()=> showSection(b.dataset.section)));
  byId('btnLogout').addEventListener('click', ()=> signOut(auth));

  // profile edit/save
  byId('btnEditProfile').addEventListener('click', ()=> { byId('profileView').classList.add('hidden'); byId('profileEdit').classList.remove('hidden'); });
  byId('btnSaveProfile').addEventListener('click', saveProfile);

  // admin delete
  byId('btnAdminDeletePost').addEventListener('click', async ()=>{
    if(me.uid !== ADMIN_UID){ toast("Not admin", "error"); return; }
    const id = byId('adminDeletePostId').value.trim(); if(!id) return toast("Enter post id", "error");
    if(await confirmDialog("Delete post", "This cannot be undone.")){ await deleteDoc(doc(db,'posts',id)); toast("Deleted", "ok"); }
  });

  // refresh suggestions
  byId('refreshSuggestions').addEventListener('click', loadSuggestions);

  // notifications
  byId('btnClearSeen').addEventListener('click', async ()=>{
    // mark seen (client: mark first 20 unread)
    const q = query(collection(db,'users',me.uid,'notifications'), where('seen','==',false), limit(20));
    const snaps = await getDocs(q);
    for(const d of snaps.docs) await updateDoc(doc(db,'users',me.uid,'notifications',d.id), { seen:true });
    toast("Marked seen");
  });

  // clicking post text image opens viewer handled per render
}

/* ========= SECTION SWITCHING with listener cleanup ========= */
function cleanupListenersForSection(section){
  // unsubscribe specific existing listeners when moving away from a section to reduce reads and memory
  if(section !== 'chat' && chatUnsub){ chatUnsub(); chatUnsub = null; currentChatCid = null; byId('chatStream').innerHTML=''; }
  // feed listener kept always live in this build; if needed, we can unsubscribe here
}

function showSection(section){
  cleanupListenersForSection(section);
  // hide all
  for(const sec of ['feed','chat','friends','leaderboard','notifications','profile']){
    byId(`section-${sec}`).classList.toggle('hidden', sec!==section);
  }
  // bottom/side nav active states
  $$('.navbtn').forEach(b=> b.classList.toggle('active', b.dataset.section===section));
  $$('.tab').forEach(t=> t.classList.toggle('active', t.dataset.section===section));
  // small UX
  window.scrollTo({top:0, behavior:'smooth'});
}

/* ========= FEED (live, paginated) ========= */
let feedUnsub = null;
async function startFeed(){
  if(feedUnsub) feedUnsub();
  const q = query(collection(db,'posts'), orderBy('createdAt','desc'), limit(20));
  feedUnsub = onSnapshot(q, snap=>{
    byId('feedList').innerHTML = '';
    snap.forEach(d=>{
      const p = d.data();
      const el = renderPost(d.id, p);
      byId('feedList').appendChild(el);
    });
    // we set cursor
    feedCursor = snap.size ? snap.docs[snap.docs.length-1] : null;
  }, err=>{
    console.error("feed error", err);
    toast("Feed load failed", "error");
  });
}

async function loadMoreFeed(){
  if(!feedCursor) return;
  const q = query(collection(db,'posts'), orderBy('createdAt','desc'), startAfter(feedCursor), limit(20));
  const snaps = await getDocs(q);
  snaps.forEach(d=>{
    byId('feedList').appendChild(renderPost(d.id,d.data()));
  });
  feedCursor = snaps.size ? snaps.docs[snaps.docs.length-1] : null;
}

/* Create post */
async function createPost(){
  const text = byId('postText').value.trim();
  const link = byId('postLink').value.trim() || null;
  if(!text && !pendingImgBase64 && !link){ toast("Write something or add an image/link", "error"); return; }
  try{
    const data = {
      uid: me.uid,
      nickname: meDoc.nickname || "Player",
      avatar: meDoc.avatar || initialsAvatar(meDoc.nickname||"Player"),
      text: text || null,
      link: link || null,
      image: pendingImgBase64 || null,
      likes: 0, comments: 0, shares: 0, createdAt: serverTimestamp()
    };
    await addDoc(collection(db,'posts'), data);
    // reward
    await updateDoc(doc(db,'users',me.uid), { points: increment(5) });
    // clear
    byId('postText').value=''; byId('postLink').value=''; byId('postImage').value=''; pendingImgBase64=null;
    toast("Posted", "ok");
  }catch(e){ console.error(e); toast("Failed to post","error"); }
}

/* Render post card (returns DOM element). Adds event listeners (comment load on demand) */
function renderPost(id, p){
  const el = document.createElement('div');
  el.className = 'glass card';
  el.style.position = 'relative';
  const created = tsToText(p.createdAt);
  const avatar = p.avatar || initialsAvatar(p.nickname||"Player");
  el.innerHTML = `
    <div class="flex gap-3">
      <img src="${avatar}" class="w-12 h-12 rounded object-cover" alt="">
      <div class="flex-1 relative">
        <div class="flex justify-between items-start">
          <div>
            <div class="font-semibold">${p.nickname||'Player'} <span class="tiny muted">¬∑ ${created}</span></div>
          </div>
          <div>
            <button data-more="${id}" class="px-2 py-1 rounded hover:bg-white/5 clickable"><i class="fa fa-ellipsis"></i></button>
            <div id="menu-${id}" class="menu glass rounded p-1 hidden">
              <button class="w-full text-left px-2 py-1 tiny" data-add="${p.uid}">Add user</button>
              <button class="w-full text-left px-2 py-1 tiny" data-report="${id}">Report</button>
              ${(me.uid===p.uid || me.uid===ADMIN_UID) ? `<button class="w-full text-left px-2 py-1 tiny text-red-400" data-delete="${id}">Delete</button>` : ''}
            </div>
          </div>
        </div>
        ${ p.text ? `<div class="post-text mt-2 text-sm">${escapeHtml(p.text)}</div>` : '' }
        ${ p.link ? `<div class="mt-2"><a class="text-[var(--accent)] tiny" target="_blank" href="${escapeHtml(p.link)}">${escapeHtml(p.link)}</a></div>` : '' }
        ${ p.image ? `<img src="${p.image}" class="img-thumb mt-2" data-zoom="${id}" alt="post image">` : '' }
        <div class="mt-2 flex items-center justify-between tiny muted">
          <div><span id="likes-${id}">${p.likes||0}</span> likes ¬∑ <span id="cmts-${id}">${p.comments||0}</span> comments</div>
          <div></div>
        </div>
        <div class="mt-2 grid grid-cols-3 gap-2">
          <button class="reaction-btn px-2 py-2 rounded bg-white/5 tiny" data-like="${id}"><i class="fa-regular fa-thumbs-up"></i> Like</button>
          <button class="reaction-btn px-2 py-2 rounded bg-white/5 tiny" data-cmt-toggle="${id}"><i class="fa-regular fa-comment"></i> Comment</button>
          <button class="reaction-btn px-2 py-2 rounded bg-white/5 tiny" data-share="${id}"><i class="fa fa-share"></i> Share</button>
        </div>
        <div id="cbox-${id}" class="comments-hidden mt-2">
          <div id="cList-${id}" class="space-y-2 max-h-48 overflow-auto"></div>
          <div class="flex gap-2 mt-2">
            <input id="cInput-${id}" class="flex-1 bg-[var(--panel)] p-2 rounded tiny" placeholder="Write a comment...">
            <button class="px-3 py-1 bg-[var(--primary)] rounded tiny" data-cmt="${id}">Send</button>
          </div>
        </div>
      </div>
    </div>
  `;

  // menu toggles
  const menuBtn = el.querySelector(`[data-more="${id}"]`);
  const menu = el.querySelector(`#menu-${id}`);
  menuBtn && menuBtn.addEventListener('click', (ev)=> { ev.stopPropagation(); menu.classList.toggle('show'); menu.classList.toggle('hidden'); });

  // add user -> send friend request
  const addBtn = el.querySelector(`[data-add="${p.uid}"]`);
  addBtn?.addEventListener('click', ()=> sendFriendRequest(p.uid));

  // report
  el.querySelector(`[data-report="${id}"]`)?.addEventListener('click', async ()=>{
    await addDoc(collection(db,'posts',id,'reports'), { from: me.uid, createdAt: serverTimestamp() });
    toast("Reported, thank you");
  });

  // delete
  el.querySelector(`[data-delete="${id}"]`)?.addEventListener('click', async ()=>{
    if(await confirmDialog("Delete post","This will be deleted permanently")){
      await deleteDoc(doc(db,'posts',id));
      toast("Post deleted", "ok");
    }
  });

  // image zoom
  const img = el.querySelector(`[data-zoom="${id}"]`);
  if(img) img.addEventListener('click', ()=> { byId('imgLarge').src = p.image; byId('imgViewer').style.display = 'flex'; });

  // like handling (atomic with per-UID likes collection + transaction to keep counts accurate)
  el.querySelector(`[data-like="${id}"]`)?.addEventListener('click', async ()=>{
    const likeDocRef = doc(db, 'posts', id, 'likes', me.uid);
    try{
      await runTransaction(db, async (t)=>{
        const likeSnap = await t.get(likeDocRef);
        const postRef = doc(db,'posts',id);
        if(likeSnap.exists()){
          t.delete(likeDocRef);
          t.update(postRef, { likes: increment(-1) });
        } else {
          t.set(likeDocRef, { uid: me.uid, createdAt: serverTimestamp() });
          t.update(postRef, { likes: increment(1) });
          // notify owner (if not self)
          if(p.uid !== me.uid){
            addDoc(collection(db,'users',p.uid,'notifications'), { type:'like', fromUid: me.uid, fromNick: meDoc.nickname, postId:id, createdAt: serverTimestamp(), seen:false });
            updateDoc(doc(db,'users',p.uid), { points: increment(1) }).catch(()=>{});
          }
        }
      });
    }catch(err){ console.error(err); toast("Failed to toggle like","error"); }
  });

  // comment toggle -> lazy load comments when opening
  el.querySelector(`[data-cmt-toggle="${id}"]`)?.addEventListener('click', ()=>{
    const box = byId(`cbox-${id}`);
    const isHidden = box.classList.contains('comments-hidden');
    if(isHidden){
      box.classList.remove('comments-hidden');
      // lazy load comments once (set up listener)
      const q = query(collection(db,'posts',id,'comments'), orderBy('createdAt','asc'), limit(200));
      const unsub = onSnapshot(q, snap=>{
        const list = byId(`cList-${id}`); list.innerHTML = '';
        snap.forEach(d=>{
          const c = d.data();
          const row = document.createElement('div');
          row.className = 'flex gap-2 items-start';
          row.innerHTML = `<img src="${c.avatar||initialsAvatar(c.nickname||'P')}" class="w-8 h-8 rounded object-cover"><div class="bg-white/5 p-2 rounded"><div class="tiny font-semibold">${c.nickname||'Player'}</div><div class="tiny">${escapeHtml(c.text)}</div><div class="tiny muted">${tsToText(c.createdAt)}</div></div>`;
          list.appendChild(row);
        });
      }, err=> console.error(err));
      // attach to unsubscribers to cleanup later when route changes
      unsubscribers[`comments_${id}`] = unsub;
    } else {
      box.classList.add('comments-hidden');
      // cleanup comment listener
      if(unsubscribers[`comments_${id}`]) { unsubscribers[`comments_${id}`](); delete unsubscribers[`comments_${id}`]; }
    }
  });

  // send comment
  el.querySelector(`[data-cmt="${id}"]`)?.addEventListener('click', async ()=>{
    const input = byId(`cInput-${id}`);
    const text = input.value.trim(); if(!text) return;
    await addDoc(collection(db,'posts',id,'comments'), { uid: me.uid, nickname: meDoc.nickname, avatar: meDoc.avatar || initialsAvatar(meDoc.nickname), text, createdAt: serverTimestamp() });
    await updateDoc(doc(db,'posts',id), { comments: increment(1) });
    // reward + notify
    if(p.uid !== me.uid) addDoc(collection(db,'users',p.uid,'notifications'), { type:'comment', fromUid: me.uid, fromNick: meDoc.nickname, postId:id, text, createdAt: serverTimestamp(), seen:false });
    await updateDoc(doc(db,'users',me.uid), { points: increment(1) }).catch(()=>{});
    input.value = '';
    toast("Comment posted", "ok");
  });

  return el;
}

/* ========= FRIENDS: requests, accept, cancel, suggestions ========= */

/* send friend request (prevents duplicates) */
async function sendFriendRequest(toUid){
  if(toUid === me.uid) return toast("You cannot add yourself", "error");
  // check if already friends
  const pairId = [me.uid, toUid].sort().join('_');
  const frSnap = await getDoc(doc(db,'friends',pairId));
  if(frSnap.exists()) return toast("Already friends", "error");
  // check existing request both directions
  const q1 = query(collection(db,'friendRequests'), where('from','==',me.uid), where('to','==',toUid), limit(1));
  const q2 = query(collection(db,'friendRequests'), where('from','==',toUid), where('to','==',me.uid), limit(1));
  const r1 = await getDocs(q1), r2 = await getDocs(q2);
  if(!r1.empty) return toast("Request already sent", "error");
  if(!r2.empty) {
    // auto-accept mutual request
    const docRef = r2.docs[0];
    await acceptFriend(docRef.id, docRef.data());
    return toast("Accepted mutual request", "ok");
  }
  // send
  await addDoc(collection(db,'friendRequests'), { from: me.uid, to: toUid, fromNick: meDoc.nickname, fromAvatar: meDoc.avatar || initialsAvatar(meDoc.nickname), createdAt: serverTimestamp() });
  await addDoc(collection(db,'users',toUid,'notifications'), { type:'friend-request', fromUid: me.uid, fromNick: meDoc.nickname, createdAt: serverTimestamp(), seen:false });
  toast("Friend request sent", "ok");
}

/* load friend related assets: incoming requests, friends list (live) */
function loadFriendAssets(){
  // incoming friend requests where to == me.uid
  const qIn = query(collection(db,'friendRequests'), where('to','==',me.uid), orderBy('createdAt','desc'));
  unsubscribers['friendRequests'] = onSnapshot(qIn, snap=>{
    const container = byId('incomingRequests'); container.innerHTML = '';
    if(snap.empty) container.innerHTML = '<div class="tiny muted">No incoming requests</div>';
    snap.forEach(d=>{
      const r = d.data();
      const el = document.createElement('div');
      el.className = 'flex items-center justify-between gap-2';
      el.innerHTML = `<div class="flex gap-2 items-center"><img src="${r.fromAvatar||initialsAvatar(r.fromNick||'U')}" class="w-10 h-10 rounded"><div><div class="font-semibold tiny">${r.fromNick||shortId(r.from)}</div><div class="tiny muted">${tsToText(r.createdAt)}</div></div></div>
      <div class="flex gap-2"><button class="px-2 py-1 bg-[var(--ok)]/20 rounded tiny" data-accept="${d.id}">Accept</button><button class="px-2 py-1 bg-white/5 rounded tiny" data-decline="${d.id}">Decline</button></div>`;
      container.appendChild(el);
      el.querySelector(`[data-accept="${d.id}"]`).addEventListener('click', ()=> acceptFriend(d.id, r));
      el.querySelector(`[data-decline="${d.id}"]`).addEventListener('click', ()=> deleteDoc(doc(db,'friendRequests',d.id)).then(()=>toast('Declined')));
    });
  });

  // friends list: we store friendships in /friends/{pairId} with uids:[a,b]
  const qFriends = query(collection(db,'friends'));
  unsubscribers['friends'] = onSnapshot(qFriends, async snap=>{
    const list = byId('friendList'); list.innerHTML = '';
    const chatUsers = byId('chatUsers'); chatUsers.innerHTML = '';
    const pairs = [];
    snap.forEach(d=> pairs.push(d.data()));
    // filter pairs including me
    const myPairs = pairs.filter(p => Array.isArray(p.uids) && p.uids.includes(me.uid));
    if(myPairs.length === 0) {
      list.innerHTML = '<div class="tiny muted">No friends yet</div>';
      chatUsers.innerHTML = '<div class="tiny muted">Add friends to message them</div>';
      return;
    }
    // for each pair, find peer uid and display
    for(const fr of myPairs){
      const peerUid = fr.uids.find(u=> u !== me.uid);
      const peerSnap = await getDoc(doc(db,'users',peerUid));
      const u = peerSnap.exists() ? peerSnap.data() : { uid:peerUid, nickname: shortId(peerUid), avatar: initialsAvatar('User') };
      // friend card
      const card = document.createElement('div');
      card.className = 'flex items-center justify-between gap-2 p-2 bg-white/3 rounded';
      card.innerHTML = `<div class="flex items-center gap-2"><img src="${u.avatar||initialsAvatar(u.nickname)}" class="w-12 h-12 rounded"><div><div class="font-semibold tiny">${u.nickname||'Player'}</div><div class="tiny muted">${shortId(u.uid)}</div></div></div>
        <div class="flex gap-1"><button class="px-2 py-1 bg-white/5 rounded tiny" data-m="${u.uid}">Msg</button><button class="px-2 py-1 bg-red-500/20 rounded tiny" data-u="${u.uid}">Unfriend</button></div>`;
      list.appendChild(card);
      card.querySelector(`[data-m="${u.uid}"]`).addEventListener('click', ()=>{ showSection('chat'); openChatWith(u); });
      card.querySelector(`[data-u="${u.uid}"]`).addEventListener('click', async ()=> {
        if(await confirmDialog('Unfriend','Remove this friend?')) {
          await deleteDoc(doc(db,'friends',[me.uid,u.uid].sort().join('_')));
          toast('Unfriended', 'ok');
        }
      });

      // chat user list item
      const li = document.createElement('div');
      li.className='flex items-center justify-between p-2 bg-white/3 rounded';
      li.innerHTML = `<div class="flex items-center gap-2"><img src="${u.avatar||initialsAvatar(u.nickname)}" class="w-10 h-10 rounded"><div><div class="font-semibold tiny">${u.nickname}</div><div class="tiny muted">Tap to chat</div></div></div><button class="px-2 py-1 bg-white/5 rounded tiny" data-open="${u.uid}"><i class="fa fa-comment"></i></button>`;
      li.querySelector(`[data-open="${u.uid}"]`).addEventListener('click', ()=> openChatWith(u));
      chatUsers.appendChild(li);
    }
  });
}

/* accept friend creates friends pair and deletes request */
async function acceptFriend(reqId, reqData){
  const pair = [reqData.from, reqData.to].sort().join('_');
  await setDoc(doc(db,'friends',pair), { uids: [reqData.from, reqData.to], since: serverTimestamp() });
  await deleteDoc(doc(db,'friendRequests', reqId));
  toast('Friend added', 'ok');
}

/* ========= SUGGESTIONS ========= */
async function loadSuggestions(){
  // naive: pick 20 newest users excluding self and existing friends and requests
  const usersSnap = await getDocs(query(collection(db,'users'), orderBy('createdAt','desc'), limit(60)));
  // collect my friends
  const friendsSnap = await getDocs(query(collection(db,'friends')));
  const myFriendUids = new Set();
  friendsSnap.forEach(d=>{
    const fr = d.data();
    if(Array.isArray(fr.uids) && fr.uids.includes(me.uid)){
      myFriendUids.add(fr.uids.find(u=>u!==me.uid));
    }
  });
  // outgoing requests
  const outgoing = await getDocs(query(collection(db,'friendRequests'), where('from','==',me.uid)));
  const outSet = new Set(outgoing.docs.map(d=>d.data().to));
  const container = byId('friendSuggestions'); container.innerHTML='';
  usersSnap.forEach(d=>{
    const u = d.data();
    if(!u || u.uid===me.uid) return;
    if(myFriendUids.has(u.uid) || outSet.has(u.uid)) return;
    // create card
    const c = document.createElement('div');
    c.className = 'p-2 bg-white/3 rounded flex flex-col items-center gap-2';
    c.innerHTML = `<img src="${u.avatar||initialsAvatar(u.nickname)}" class="w-12 h-12 rounded"><div class="tiny font-semibold">${u.nickname||shortId(u.uid)}</div><button class="px-2 py-1 bg-[var(--primary)] rounded tiny" data-add="${u.uid}">Add</button>`;
    c.querySelector('[data-add]')?.addEventListener('click', ()=> sendFriendRequest(u.uid));
    container.appendChild(c);
  });
}

/* ========= PRIVATE CHAT implementation (append only) ========= */
function convoIdFor(a,b){ return [a,b].sort().join('_'); }
function openChatWith(u){
  chatPeer = u;
  byId('chatPeerNick').textContent = u.nickname || 'Player';
  byId('chatPeerAvatar').src = u.avatar || initialsAvatar(u.nickname||'Player');
  byId('chatPeerStatus').textContent = 'Online';
  showSection('chat');

  if(chatUnsub) { chatUnsub(); chatUnsub=null; currentChatCid=null; byId('chatStream').innerHTML=''; }

  const cid = convoIdFor(me.uid, u.uid);
  currentChatCid = cid;
  // create chat doc if not exists (members array)
  setDoc(doc(db,'chats',cid), { members: [me.uid, u.uid], updatedAt: serverTimestamp() }, { merge: true }).catch(()=>{});
  // listen to messages append-only
  const q = query(collection(db,'chats',cid,'messages'), orderBy('createdAt','asc'), limit(200));
  chatUnsub = onSnapshot(q, snap=>{
    const box = byId('chatStream');
    box.innerHTML = '';
    snap.forEach(d=>{
      const m = d.data();
      const mine = m.from === me.uid;
      const row = document.createElement('div');
      row.className = `max-w-[75%] ${mine? 'ml-auto text-right':'mr-auto'}`;
      row.innerHTML = `<div class="p-2 rounded ${mine? 'bg-[var(--primary)] text-white':'bg-white/5'} tiny">${escapeHtml(m.text)}<div class="tiny muted mt-1">${tsToText(m.createdAt)}</div></div>`;
      box.appendChild(row);
    });
    box.scrollTop = box.scrollHeight;
  });
}

async function sendChat(){
  const text = byId('chatInput').value.trim(); if(!text || !currentChatCid) return;
  const cid = currentChatCid;
  await addDoc(collection(db,'chats',cid,'messages'), { from: me.uid, to: chatPeer.uid, text, createdAt: serverTimestamp() });
  await updateDoc(doc(db,'chats',cid), { updatedAt: serverTimestamp() });
  // notify
  await addDoc(collection(db,'users',chatPeer.uid,'notifications'), { type:'dm', fromUid: me.uid, fromNick: meDoc.nickname, text, createdAt: serverTimestamp(), seen:false });
  byId('chatInput').value = '';
}

/* ========= NOTIFICATIONS ========= */
function startNotifications(){
  const q = query(collection(db,'users',me.uid,'notifications'), orderBy('createdAt','desc'), limit(100));
  unsubscribers['notifs'] = onSnapshot(q, snap=>{
    const list = byId('notifList'); list.innerHTML = '';
    let unseen = 0;
    snap.forEach(d=>{
      const n = d.data();
      if(!n.seen) unseen++;
      const row = document.createElement('div');
      row.className = 'p-2 bg-white/3 rounded flex gap-2 items-start';
      row.innerHTML = `<div class="w-9 h-9 rounded bg-white/5 flex items-center justify-center tiny"><i class="fa ${n.type==='dm'?'fa-message': n.type==='like'?'fa-thumbs-up': n.type==='comment'?'fa-comment':'fa-user-plus'}"></i></div>
        <div class="flex-1"><div class="tiny font-semibold">${n.fromNick || 'Someone'}</div><div class="tiny muted">${n.text || ''}</div><div class="tiny muted mt-1">${tsToText(n.createdAt)}</div></div>
        <div><button class="px-2 py-1 bg-white/5 rounded tiny" data-mark="${d.id}">Mark</button></div>`;
      row.querySelector(`[data-mark="${d.id}"]`).addEventListener('click', ()=> updateDoc(doc(db,'users',me.uid,'notifications',d.id), { seen:true }));
      list.appendChild(row);
    });
    byId('notifDot').classList.toggle('hidden', unseen === 0);
  }, err=> console.error(err));
}

/* ========= LEADERBOARD ========= */
function loadLeaderboard(){
  const q = query(collection(db,'users'), orderBy('points','desc'), limit(50));
  unsubscribers['leader'] = onSnapshot(q, snap=>{
    const rows = byId('leaderRows'); rows.innerHTML = '';
    let i=0;
    snap.forEach(d=>{
      const u = d.data(); i++;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="tiny">${i}</td><td class="tiny">${shortId(u.uid)}</td><td class="tiny">${u.nickname||'Player'}</td><td class="tiny">${u.points||0}</td><td class="tiny">Lv ${rankFromPoints(u.points||0)}</td>`;
      rows.appendChild(tr);
    });
  });
}

/* ========= PROFILE SAVE & VIEW ========= */
function preloadProfileViewOrEdit(){
  // if user has filled profile fields, show view else edit
  let has = false;
  if(meDoc){
    const keys = ['nickname','gamerName','bio','language','country','games'];
    has = keys.some(k => meDoc[k] && meDoc[k].toString().trim().length>0);
  }
  if(has){
    fillProfileView();
    byId('profileView').classList.remove('hidden'); byId('profileEdit').classList.add('hidden');
  } else {
    fillProfileEdit();
    byId('profileView').classList.add('hidden'); byId('profileEdit').classList.remove('hidden');
  }
}

function fillProfileView(){
  const fall = initialsAvatar(meDoc.nickname||"Player");
  byId('pvAvatar').src = meDoc.avatar || fall;
  byId('pvNick').textContent = meDoc.nickname || "Player";
  byId('pvRank').textContent = rankFromPoints(meDoc.points||0);
  byId('pvPoints').textContent = meDoc.points||0;
  byId('pvBio').textContent = meDoc.bio || "";
  byId('pvGamer').textContent = meDoc.gamerName || "";
  byId('pvSex').textContent = meDoc.sex || "";
  byId('pvDob').textContent = meDoc.dob || "";
  byId('pvLang').textContent = meDoc.language || "";
  byId('pvCountry').textContent = meDoc.country || "";
  byId('pvGames').textContent = meDoc.games || "";
}

function fillProfileEdit(){
  byId('setNick').value = meDoc.nickname || "";
  byId('setGamer').value = meDoc.gamerName || "";
  byId('setSex').value = meDoc.sex || "";
  byId('setDob').value = meDoc.dob || "";
  byId('setLang').value = meDoc.language || "";
  byId('setCountry').value = meDoc.country || "";
  byId('setGames').value = meDoc.games || "";
  byId('setBio').value = meDoc.bio || "";
}

async function saveProfile(){
  const nickname = byId('setNick').value.trim() || meDoc.nickname || "Player";
  const gamerName = byId('setGamer').value.trim() || nickname;
  const sex = byId('setSex').value || "";
  const dob = byId('setDob').value || "";
  const language = byId('setLang').value.trim() || "";
  const country = byId('setCountry').value.trim() || "";
  const games = byId('setGames').value.trim() || "";
  const bio = byId('setBio').value.trim() || "";
  let avatarData = meDoc.avatar || initialsAvatar(nickname);
  const f = byId('setAvatar').files?.[0];
  if(f){
    if(f.size > 5*1024*1024){ toast("Avatar too large (max 5MB)", "error"); return; }
    try{ avatarData = await fileToBase64(f, 800, .8); }catch(e){ console.error(e); toast("Avatar failed", "error"); }
  }
  await updateDoc(doc(db,'users',me.uid), { nickname, gamerName, sex, dob, language, country, games, bio, avatar: avatarData, updatedAt: serverTimestamp() });
  meDoc = (await getDoc(doc(db,'users',me.uid))).data();
  fillProfileView();
  byId('profileSaved').classList.remove('hidden'); setTimeout(()=>byId('profileSaved').classList.add('hidden'), 1200);
  toast("Profile updated", "ok");
  // switch to view
  byId('profileView').classList.remove('hidden'); byId('profileEdit').classList.add('hidden');
  // update header avatars/names
  for(const id of ['navAvatar','cpAvatar','sideAvatar','pvAvatar']) if(byId(id)) byId(id).src = meDoc.avatar || initialsAvatar(meDoc.nickname);
  if(byId('navNick')) byId('navNick').textContent = meDoc.nickname || 'Player';
}

/* ========= UTIL: shortId & escapeHtml ========= */
function shortId(id=''){ return (id||'').slice(0,4) + '‚Ä¶' + (id||'').slice(-2); }
function escapeHtml(s=''){ return String(s).replace(/[&<>"'`]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;' })[c]); }

/* ========= CLEANUP before unload (unsubscribe all) ========= */
window.addEventListener('beforeunload', ()=>{
  for(const k in unsubscribers) if(typeof unsubscribers[k]==='function') unsubscribers[k]();
  if(feedUnsub) feedUnsub();
  if(chatUnsub) chatUnsub();
});

/* ========= INITIAL small helpers (escape) ========= */
(function attachDocClicks(){
  // delegate open image viewer
  document.addEventListener('click', (e)=>{
    if(e.target.matches('.img-thumb')) {
      const src = e.target.src;
      byId('imgLarge').src = src;
      byId('imgViewer').style.display = 'flex';
    }
  });
})();

/* End of module */
</script>

<!-- Non-module tiny helpers for older browsers -->
<script>
  // small event: hide profile menu when esc
  document.addEventListener('keydown', function(e){
    if(e.key === 'Escape'){
      document.querySelectorAll('.menu').forEach(m=> m.classList.remove('show'));
      document.getElementById('imgViewer')?.style?.display && (document.getElementById('imgViewer').style.display = 'none');
      document.getElementById('confirmModal') && (document.getElementById('confirmModal').style.display='none');
    }
  });
</script>

</body>
</html>
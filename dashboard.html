<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mod Hive Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background-color: #0a0a0a; color: white; font-family: 'Segoe UI', sans-serif; }
.navbar { background: #0f0f0f; border-bottom: 2px solid #00f0ff; padding: 0.5rem; }
button, .btn { background: #00f0ff; color: black; padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: bold; cursor: pointer; }
button:hover, .btn:hover { background: #00c0cc; }
.card { background: #111; border: 1px solid #00f0ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
input, textarea { background: #1a1a1a; border: 1px solid #333; border-radius: 6px; padding: 0.5rem; width: 100%; color: white; }
.friend-btn { background: #1a1a1a; border: 1px solid #00f0ff; color: #00f0ff; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; }
.friend-btn:hover { background: #00f0ff; color: black; }
.chat-box { height: 200px; overflow-y: auto; background: #000; padding: 0.5rem; border-radius: 6px; }
</style>
</head>
<body>

<!-- Top Nav -->
<div class="navbar flex justify-between items-center">
  <div class="flex items-center gap-3">
    <img id="profilePic" class="w-10 h-10 rounded-full border border-cyan-400" src="">
    <span id="username" class="font-bold text-cyan-400"></span>
  </div>
  <div class="flex gap-3">
    <button onclick="goMain()">üè† Main Page</button>
    <button onclick="logout()">Logout</button>
  </div>
</div>

<div class="p-4 grid lg:grid-cols-3 gap-4">

  <!-- Profile Settings -->
  <div class="card">
    <h2 class="text-xl mb-2">Profile Settings</h2>
    <input id="nickname" placeholder="Custom Username">
    <input type="file" id="profileFile">
    <textarea id="bio" placeholder="Your bio"></textarea>
    <button onclick="saveProfile()">Save Profile</button>
  </div>

  <!-- Posts -->
  <div class="card col-span-2">
    <h2 class="text-xl mb-2">Create Post</h2>
    <textarea id="postText" placeholder="What's on your mind? Links auto-detected."></textarea>
    <input type="file" id="postFile">
    <button onclick="createPost()">Post</button>
    <div id="posts" class="mt-4"></div>
  </div>

</div>

<!-- Friends & Chat -->
<div class="p-4 grid lg:grid-cols-3 gap-4">
  <div class="card">
    <h2 class="text-lg mb-2">Friend Suggestions</h2>
    <div id="friendSuggestions"></div>
  </div>

  <div class="card col-span-2">
    <h2 class="text-lg mb-2">Global Chat</h2>
    <div id="chatMessages" class="chat-box"></div>
    <input id="chatInput" placeholder="Type a message...">
    <input type="file" id="chatFile">
    <button onclick="sendGlobalChat()">Send</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<script>
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAgx0jy6we6cvnIgKbS1fBoeRfSD2MDszo",
  authDomain: "mod-hive.firebaseapp.com",
  projectId: "mod-hive",
  storageBucket: "mod-hive.firebasestorage.app",
  messagingSenderId: "982583858832",
  appId: "1:982583858832:web:44d5e4e2edd77fac06ea15",
  measurementId: "G-PK2DRED7FB"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
const ADMIN_UID = "7aTPZ6wEIpQaPjlXWDrz5Ajc4By1";

let currentUser;

// Convert text to clickable links
function linkify(text) {
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  return text.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-cyan-400 underline">${url}</a>`);
}

// Auth check
auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "auth.html";
  } else {
    currentUser = user;
    loadUserProfile();
    loadPosts();
    loadFriendSuggestions();
    loadGlobalChat();
  }
});

// Profile load
function loadUserProfile() {
  db.collection("users").doc(currentUser.uid).get().then(doc => {
    if (doc.exists) {
      const data = doc.data();
      document.getElementById("username").innerText = data.nickname || currentUser.email;
      document.getElementById("profilePic").src = data.profilePhoto || "default.png";
      document.getElementById("nickname").value = data.nickname || "";
      document.getElementById("bio").value = data.bio || "";
    }
  });
}

// Save profile
function saveProfile() {
  const nickname = document.getElementById("nickname").value;
  const bio = document.getElementById("bio").value;
  const file = document.getElementById("profileFile").files[0];
  
  if (file) {
    const ref = storage.ref(`profilePics/${currentUser.uid}`);
    ref.put(file).then(() => ref.getDownloadURL()).then(url => {
      db.collection("users").doc(currentUser.uid).update({ nickname, bio, profilePhoto: url });
    });
  } else {
    db.collection("users").doc(currentUser.uid).update({ nickname, bio });
  }
}

// Create post
function createPost() {
  const text = document.getElementById("postText").value;
  const file = document.getElementById("postFile").files[0];
  const postRef = db.collection("posts").doc();
  
  if (file) {
    const ref = storage.ref(`posts/${postRef.id}`);
    ref.put(file).then(() => ref.getDownloadURL()).then(url => {
      savePost(postRef, text, url);
    });
  } else {
    savePost(postRef, text, null);
  }
}

function savePost(postRef, text, mediaUrl) {
  db.collection("users").doc(currentUser.uid).get().then(doc => {
    const nickname = doc.data().nickname || currentUser.email;
    postRef.set({
      uid: currentUser.uid,
      author: nickname,
      text,
      media: mediaUrl || "",
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      likes: [],
      comments: []
    });
  });
}

// Load posts
function loadPosts() {
  db.collection("posts").orderBy("createdAt", "desc").onSnapshot(snapshot => {
    const postsDiv = document.getElementById("posts");
    postsDiv.innerHTML = "";
    snapshot.forEach(doc => {
      const post = doc.data();
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <p class="font-bold">${post.author}</p>
        <p>${linkify(post.text)}</p>
        ${post.media ? `<img src="${post.media}" class="max-h-48 mt-2">` : ""}
        <div class="flex gap-2 mt-2">
          <button onclick="likePost('${doc.id}')">üëç ${post.likes.length}</button>
          ${currentUser.uid === ADMIN_UID ? `<button onclick="deletePost('${doc.id}')">üóë Delete</button>` : ""}
        </div>
      `;
      postsDiv.appendChild(div);
    });
  });
}

// Like post
function likePost(id) {
  const ref = db.collection("posts").doc(id);
  ref.update({
    likes: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
  });
}

// Delete post (admin only)
function deletePost(id) {
  db.collection("posts").doc(id).delete();
}

// Friend suggestions
function loadFriendSuggestions() {
  db.collection("users").get().then(snapshot => {
    const suggestionsDiv = document.getElementById("friendSuggestions");
    suggestionsDiv.innerHTML = "";
    snapshot.forEach(doc => {
      if (doc.id !== currentUser.uid) {
        const user = doc.data();
        const div = document.createElement("div");
        div.className = "flex justify-between items-center mb-2";
        div.innerHTML = `
          <span>${user.nickname || user.email}</span>
          <button class="friend-btn" onclick="addFriend('${doc.id}')">Add Friend</button>
        `;
        suggestionsDiv.appendChild(div);
      }
    });
  });
}

// Add friend
function addFriend(uid) {
  db.collection("users").doc(currentUser.uid).update({
    friends: firebase.firestore.FieldValue.arrayUnion(uid)
  });
}

// Global chat
function loadGlobalChat() {
  db.collection("globalChat").orderBy("createdAt").onSnapshot(snapshot => {
    const chatDiv = document.getElementById("chatMessages");
    chatDiv.innerHTML = "";
    snapshot.forEach(doc => {
      const msg = doc.data();
      const p = document.createElement("p");
      p.innerHTML = `${msg.author}: ${linkify(msg.text)}`;
      chatDiv.appendChild(p);
    });
    chatDiv.scrollTop = chatDiv.scrollHeight;
  });
}

function sendGlobalChat() {
  const text = document.getElementById("chatInput").value;
  const file = document.getElementById("chatFile").files[0];
  
  if (file) {
    const ref = storage.ref(`chatFiles/${Date.now()}_${file.name}`);
    ref.put(file).then(() => ref.getDownloadURL()).then(url => {
      sendChatMessage(`${text} ${url}`);
    });
  } else {
    sendChatMessage(text);
  }
}

function sendChatMessage(message) {
  db.collection("users").doc(currentUser.uid).get().then(doc => {
    const nickname = doc.data().nickname || currentUser.email;
    db.collection("globalChat").add({
      uid: currentUser.uid,
      author: nickname,
      text: message,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById("chatInput").value = "";
    document.getElementById("chatFile").value = "";
  });
}

// Go to main page
function goMain() {
  window.location.href = "ModHive.html";
}

// Logout
function logout() {
  auth.signOut();
}
</script>

</body>
</html>

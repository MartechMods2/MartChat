<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mod Hive — Dashboard</title>

  <!-- Tailwind + Font Awesome -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --mh-primary:#6c5ce7; --mh-primary-2:#5649c0; --mh-accent:#00cec9;
      --mh-dark:#0b0f13; --mh-panel:#111317; --mh-muted:#93a1b1;
      --ok:#10b981; --danger:#ef4444;
    }
    html,body,#root{height:100%}
    body{background:var(--mh-dark); color:#e8eef6; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
    .glass{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); backdrop-filter: blur(6px)}
    .tiny{font-size:.85rem}
    .muted{color:var(--mh-muted)}
    .btn{transition:transform .08s ease}
    .btn:active{transform:scale(.985)}
    .spinner{width:22px;height:22px;border-radius:999px;border:3px solid rgba(255,255,255,.08);border-top-color:var(--mh-primary);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .img-thumb{width:100%;max-height:420px;object-fit:cover;border-radius:8px;cursor:zoom-in}
    .comments-hidden{display:none}
    .menu{position:absolute;right:8px;top:36px;min-width:160px;display:none}
    .menu.show{display:block}
    .nav-active{background:rgba(255,255,255,.04)}
    /* mobile-first layout */
    .layout{display:grid; grid-template-columns:1fr; gap:12px; padding:12px; max-width:1100px; margin:0 auto}
    @media(min-width:1000px){ .layout { grid-template-columns: 280px 1fr 320px; padding:20px } }
    /* bottom-tab for mobile */
    .bottom-tab{position:fixed;left:0;right:0;bottom:0;z-index:60;background:var(--mh-panel);border-top:1px solid rgba(255,255,255,.03);display:flex}
    .bottom-tab button{flex:1;padding:10px 0;color:#cbd6ef80}
    .bottom-tab .active{color:#fff}
    /* ensure app fits viewport on mobile */
    .app-wrap{min-height:100vh; display:flex; flex-direction:column;}
    /* skeleton loader */
    .skeleton{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border-radius:6px; height:12px}
    /* small responsive fixes */
    .hidden-md { display: none; }
    @media(min-width:768px) { .hidden-md { display: block; } }
  </style>
</head>
<body class="antialiased">

  <!-- Gate spinner while auth checked -->
  <div id="gate" class="fixed inset-0 z-50 flex items-center justify-center bg-[var(--mh-dark)]/95">
    <div class="glass p-6 rounded-lg text-center w-11/12 max-w-sm">
      <div class="mx-auto mb-3 spinner"></div>
      <h2 class="text-lg font-semibold">Mod Hive</h2>
      <p class="muted tiny mt-2">Checking your session…</p>
    </div>
  </div>

  <!-- image viewer modal -->
  <div id="imgViewer" class="fixed inset-0 hidden items-center justify-center z-60 bg-black/80">
    <button id="imgClose" class="absolute top-4 right-4 p-2 rounded bg-white/10 text-white"><i class="fa fa-times"></i></button>
    <img id="imgLarge" src="" class="max-w-[96vw] max-h-[86vh] rounded" alt=""/>
  </div>

  <!-- confirm modal -->
  <div id="confirmModal" class="fixed inset-0 hidden items-center justify-center z-70 bg-black/60">
    <div class="glass rounded p-4 max-w-sm w-11/12">
      <h3 id="confirmTitle" class="font-semibold">Confirm</h3>
      <p id="confirmText" class="muted tiny mt-1">Are you sure?</p>
      <div class="mt-4 flex justify-end gap-2">
        <button id="confirmCancel" class="px-3 py-1 rounded bg-white/10">Cancel</button>
        <button id="confirmOk" class="px-3 py-1 rounded bg-[var(--danger)] text-white">OK</button>
      </div>
    </div>
  </div>

  <!-- toast container -->
  <div id="toasts" class="fixed right-4 bottom-24 z-80 space-y-2"></div>

  <div id="root" class="app-wrap hidden">
    <!-- topbar -->
    <header class="glass w-full border-b border-white/5 py-3 px-3 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button id="burger" class="md:hidden p-2 rounded bg-white/5 btn"><i class="fa fa-bars"></i></button>
          <div class="flex items-center gap-2">
            <div id="logo" class="w-8 h-8 rounded bg-[var(--mh-primary)] flex items-center justify-center text-white font-bold">MH</div>
            <div><div class="font-semibold">Mod Hive</div><div class="tiny muted">Gaming social</div></div>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <div class="hidden md:flex items-center bg-[var(--mh-panel)] rounded px-2 py-1">
            <i class="fa fa-search text-white/50 mr-2"></i>
            <input id="searchBox" placeholder="Search posts, users…" class="bg-transparent outline-none text-sm text-white/75 w-64"/>
          </div>
          <button id="notifBtn" class="p-2 rounded bg-white/5 relative btn"><i class="fa-regular fa-bell"></i><span id="notifDot" class="absolute -top-0.5 -right-0.5 w-2.5 h-2.5 rounded-full bg-[var(--mh-accent)] hidden"></span></button>
          <div class="relative">
            <button id="profileBtn" class="flex items-center gap-2 px-2 py-1 rounded bg-white/5 btn">
              <img id="navAvatar" class="w-8 h-8 rounded object-cover" src="" alt="avatar">
              <span id="navNick" class="hidden md:inline tiny">Player</span>
            </button>
            <div id="profileMenu" class="menu glass rounded p-2">
              <button data-section="profile" class="w-full text-left px-2 py-2 rounded hover:bg-white/5">Profile</button>
              <button data-section="notifications" class="w-full text-left px-2 py-2 rounded hover:bg-white/5">Notifications</button>
              <button id="btnLogout" class="w-full text-left px-2 py-2 rounded hover:bg-white/5 text-red-400">Sign out</button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- layout -->
    <main class="layout max-w-7xl mx-auto">
      <!-- left column -->
      <aside class="space-y-3">
        <div class="glass p-3 rounded flex items-center gap-3">
          <img id="sideAvatar" class="w-12 h-12 rounded object-cover" src="">
          <div>
            <div id="sideNick" class="font-semibold">Player</div>
            <div class="tiny muted">Lv <span id="sideRank">1</span> · <span id="sidePoints">0</span> pts</div>
          </div>
        </div>

        <nav id="leftNav" class="glass p-2 rounded hidden md:block space-y-2">
          <button data-section="feed" class="navbtn w-full text-left px-3 py-2 rounded nav-active"> <i class="fa fa-house mr-2"></i> Feed</button>
          <button data-section="chat" class="navbtn w-full text-left px-3 py-2 rounded"> <i class="fa fa-message mr-2"></i> Chat</button>
          <button data-section="friends" class="navbtn w-full text-left px-3 py-2 rounded"> <i class="fa fa-user-group mr-2"></i> Friends</button>
          <button data-section="leaderboard" class="navbtn w-full text-left px-3 py-2 rounded"> <i class="fa fa-trophy mr-2"></i> Leaderboard</button>
          <button data-section="notifications" class="navbtn w-full text-left px-3 py-2 rounded"> <i class="fa fa-bell mr-2"></i> Notifications</button>
          <button data-section="profile" class="navbtn w-full text-left px-3 py-2 rounded"> <i class="fa fa-id-card mr-2"></i> Profile</button>
          <a href="main.html" class="w-full text-left px-3 py-2 rounded hover:bg-white/5 block"> <i class="fa fa-rotate-left mr-2"></i> Back to main</a>
        </nav>

        <div id="friendSuggestionsCard" class="glass p-3 rounded">
          <div class="flex items-center justify-between"><div class="font-semibold">Suggestions</div><button id="refreshSuggestions" class="tiny muted">Refresh</button></div>
          <div id="friendSuggestions" class="mt-2 grid grid-cols-3 gap-2"></div>
        </div>

        <div id="adminCard" class="glass p-3 rounded hidden">
          <div class="font-semibold text-red-300">Admin</div>
          <input id="adminDeletePostId" placeholder="Post ID" class="mt-2 w-full bg-[var(--mh-panel)] p-2 rounded tiny"/>
          <div class="mt-2 flex gap-2"><button id="btnAdminDeletePost" class="px-3 py-1 bg-red-500 rounded btn">Delete</button></div>
        </div>
      </aside>

      <!-- center: main content -->
      <section class="space-y-3">
        <!-- FEED -->
        <div id="section-feed" class="space-y-3">
          <div class="glass p-3 rounded">
            <div class="flex gap-3">
              <img id="cpAvatar" class="w-10 h-10 rounded object-cover" src="">
              <div class="flex-1">
                <textarea id="postText" rows="2" class="w-full bg-transparent outline-none resize-none text-sm" placeholder="Share your gaming moment..."></textarea>
                <div class="mt-2 flex items-center gap-2 flex-wrap">
                  <label class="px-3 py-1 bg-white/5 rounded cursor-pointer"><i class="fa-regular fa-image mr-2"></i><span class="tiny">Image</span><input id="postImage" class="hidden" type="file" accept="image/*"></label>
                  <div class="flex items-center bg-[var(--mh-panel)] rounded px-2 py-1">
                    <i class="fa fa-link text-white/50 mr-2"></i>
                    <input id="postLink" class="bg-transparent outline-none text-sm w-36" placeholder="Optional link"/>
                  </div>
                  <button id="btnPost" class="ml-auto px-3 py-1 bg-[var(--mh-primary)] rounded btn">Post</button>
                </div>
              </div>
            </div>
          </div>

          <!-- feed list -->
          <div id="feedList" class="space-y-3 min-h-[120px]">
            <!-- skeleton while loading -->
            <div id="feedSkeleton" class="space-y-2">
              <div class="glass p-3 rounded"><div class="flex gap-3"><div class="skeleton w-12 h-12"></div><div class="flex-1"><div class="skeleton w-1/4 mb-2"></div><div class="skeleton w-full"></div></div></div></div>
            </div>
          </div>
        </div>

        <!-- CHAT -->
        <div id="section-chat" class="hidden space-y-3">
          <div class="glass p-3 rounded">
            <div class="font-semibold">Private Chats</div>
            <input id="chatSearch" class="mt-2 w-full bg-[var(--mh-panel)] p-2 rounded tiny" placeholder="Find friend...">
            <div id="chatUsers" class="mt-2 space-y-2 max-h-[42vh] overflow-auto"></div>
          </div>

          <div class="glass p-3 rounded">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <img id="chatPeerAvatar" class="w-10 h-10 rounded object-cover" src="">
                <div>
                  <div id="chatPeerNick" class="font-semibold tiny">Select friend</div>
                  <div id="chatPeerStatus" class="muted tiny">—</div>
                </div>
              </div>
              <div class="tiny muted">Private</div>
            </div>

            <div id="chatStream" class="mt-3 max-h-[44vh] overflow-auto space-y-2"></div>
            <div class="mt-3 flex gap-2 items-center">
              <input id="chatInput" class="flex-1 bg-[var(--mh-panel)] p-2 rounded tiny" placeholder="Type message (Enter to send)"/>
              <button id="btnSendChat" class="px-3 py-2 bg-[var(--mh-primary)] rounded"><i class="fa fa-paper-plane"></i></button>
            </div>
          </div>
        </div>

        <!-- FRIENDS -->
        <div id="section-friends" class="hidden space-y-3">
          <div class="glass p-3 rounded">
            <div class="font-semibold">Incoming Requests</div>
            <div id="incomingRequests" class="mt-2 space-y-2"></div>
          </div>

          <div class="glass p-3 rounded">
            <div class="font-semibold">Your Friends</div>
            <div id="friendList" class="mt-2 grid grid-cols-2 gap-2"></div>
          </div>
        </div>

        <!-- LEADERBOARD -->
        <div id="section-leaderboard" class="hidden">
          <div class="glass p-3 rounded">
            <div class="font-semibold">Top Players</div>
            <div class="mt-3 overflow-auto"><table class="w-full tiny"><thead class="muted text-left"><tr><th>#</th><th>Nick</th><th>Points</th></tr></thead><tbody id="leaderRows"></tbody></table></div>
          </div>
        </div>

        <!-- NOTIFICATIONS -->
        <div id="section-notifications" class="hidden">
          <div class="glass p-3 rounded">
            <div class="flex justify-between items-center"><div class="font-semibold">Notifications</div><button id="btnClearSeen" class="tiny muted">Mark seen</button></div>
            <div id="notifList" class="mt-2 space-y-2"></div>
          </div>
        </div>

        <!-- PROFILE -->
        <div id="section-profile" class="hidden">
          <div class="glass p-3 rounded">
            <div class="flex items-center gap-3">
              <img id="pvAvatar" class="w-16 h-16 rounded object-cover" src="">
              <div>
                <div id="pvNick" class="font-semibold">Player</div>
                <div class="tiny muted">Lv <span id="pvRank">1</span> · <span id="pvPoints">0</span> pts</div>
              </div>
            </div>

            <div id="profileView" class="mt-3 hidden">
              <div id="pvBio" class="muted tiny"></div>
              <div class="mt-3 grid grid-cols-2 gap-2 tiny muted">
                <div>Gamer name: <span id="pvGamer"></span></div>
                <div>Sex: <span id="pvSex"></span></div>
                <div>DOB: <span id="pvDob"></span></div>
                <div>Lang: <span id="pvLang"></span></div>
                <div>Country: <span id="pvCountry"></span></div>
                <div>Games: <span id="pvGames"></span></div>
              </div>
              <div class="mt-3"><button id="btnEditProfile" class="px-3 py-1 bg-white/5 rounded tiny">Edit Profile</button></div>
            </div>

            <div id="profileEdit" class="mt-3">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <input id="setNick" placeholder="Nickname" class="bg-[var(--mh-panel)] p-2 rounded tiny"/>
                <input id="setGamer" placeholder="Gamer name" class="bg-[var(--mh-panel)] p-2 rounded tiny"/>
                <select id="setSex" class="bg-[var(--mh-panel)] p-2 rounded tiny"><option value="">Prefer not</option><option>Male</option><option>Female</option><option>Other</option></select>
                <input id="setDob" type="date" class="bg-[var(--mh-panel)] p-2 rounded tiny"/>
                <input id="setLang" placeholder="Language" class="bg-[var(--mh-panel)] p-2 rounded tiny"/>
                <input id="setCountry" placeholder="Country" class="bg-[var(--mh-panel)] p-2 rounded tiny"/>
                <input id="setGames" placeholder="Games (comma separated)" class="bg-[var(--mh-panel)] p-2 rounded tiny sm:col-span-2"/>
                <input id="setAvatar" type="file" accept="image/*" class="tiny sm:col-span-2"/>
                <textarea id="setBio" rows="3" placeholder="Bio" class="bg-[var(--mh-panel)] p-2 rounded tiny sm:col-span-2"></textarea>
              </div>
              <div class="mt-3 flex gap-2">
                <button id="btnSaveProfile" class="px-3 py-1 bg-[var(--mh-primary)] rounded">Save</button>
                <span id="profileSaved" class="hidden tiny text-[var(--ok)]">Saved ✓</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- right column (hidden on mobile) -->
      <aside class="hidden md:block">
        <div class="glass p-3 rounded">
          <div class="font-semibold">Trending</div>
          <div class="mt-2 grid gap-2"><div class="p-2 bg-white/5 rounded tiny">Valorant</div><div class="p-2 bg-white/5 rounded tiny">Skyrim</div></div>
        </div>
        <div id="onlineFriends" class="glass p-3 rounded mt-3 tiny muted">
          <div class="font-semibold">Online</div><div id="onlineList" class="mt-2"></div>
        </div>
      </aside>
    </main>

    <!-- mobile bottom nav -->
    <div class="bottom-tab md:hidden">
      <button data-section="feed" class="tab active"> <i class="fa fa-house"></i> </button>
      <button data-section="chat" class="tab"> <i class="fa fa-message"></i> </button>
      <button data-section="friends" class="tab"> <i class="fa fa-user-group"></i> </button>
      <button data-section="leaderboard" class="tab"> <i class="fa fa-trophy"></i> </button>
      <button data-section="profile" class="tab"> <i class="fa fa-id-card"></i> </button>
    </div>
  </div>

<!-- Firebase module -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, serverTimestamp,
    onSnapshot, query, where, orderBy, limit, getDocs, deleteDoc, runTransaction
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

 // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAgx0jy6we6cvnIgKbS1fBoeRfSD2MDszo",
  authDomain: "mod-hive.firebaseapp.com",
  projectId: "mod-hive",
  storageBucket: "mod-hive.firebasestorage.app",
  messagingSenderId: "982583858832",
  appId: "1:982583858832:web:44d5e4e2edd77fac06ea15",
  measurementId: "G-PK2DRED7FB"
};
  const ADMIN_UID = "7aTPZ6wEIpQaPjlXWDrz5Ajc4By1";
  /* ========================================================== */

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // state
  let me = null;
  let meDoc = null;
  const unsub = {}; // store unsubscribe functions
  let feedUnsub = null;
  let chatUnsub = null;
  let currentChatCid = null;
  let pendingImgBase64 = null;
  let authResolved = false;

  // DOM helpers
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const byId = id => document.getElementById(id);

  // utils
  function toast(msg, type="info"){
    const wrap = byId('toasts');
    const el = document.createElement('div');
    el.className = 'glass px-3 py-2 rounded flex items-center gap-3';
    el.style.minWidth = '200px';
    el.innerHTML = `${type==='ok'? "<i class='fa fa-check text-[var(--ok)]'></i>" : type==='error'? "<i class='fa fa-triangle-exclamation text-[var(--danger)]'></i>" : "<i class='fa fa-bell'></i>"}<div class="flex-1">${msg}</div>`;
    wrap.appendChild(el);
    setTimeout(()=>{ el.style.transition='opacity .25s, transform .25s'; el.style.opacity='0'; el.style.transform='translateY(8px)'; setTimeout(()=>el.remove(),270); }, 2600);
  }

  function confirmDialog(title, text){
    return new Promise(resolve=>{
      byId('confirmTitle').textContent = title;
      byId('confirmText').textContent = text;
      const modal = byId('confirmModal'); modal.classList.remove('hidden'); modal.style.display='flex';
      const ok = byId('confirmOk'), cancel = byId('confirmCancel');
      const cleanup = ()=>{ modal.classList.add('hidden'); modal.style.display='none'; ok.onclick = cancel.onclick = null; };
      ok.onclick = ()=>{ cleanup(); resolve(true); };
      cancel.onclick = ()=>{ cleanup(); resolve(false); };
    });
  }

  function initialsAvatar(name="Player", size=128){
    const initials = (name||'').split(/\s+/).map(p=>p[0]||'').slice(0,2).join('').toUpperCase() || 'P';
    const colors = ['#6c5ce7','#00cec9','#fd79a8','#0984e3','#00b894','#e17055','#e84393'];
    const bg = colors[(initials.charCodeAt(0)||1) % colors.length];
    const c = document.createElement('canvas'); c.width=c.height=size;
    const ctx = c.getContext('2d'); ctx.fillStyle=bg; ctx.fillRect(0,0,size,size);
    ctx.fillStyle='#fff'; ctx.font = `${Math.round(size*0.45)}px sans-serif`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(initials, size/2, size/2);
    return c.toDataURL('image/png');
  }

  function tsToText(ts){
    try { const d = ts?.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString(); } catch { return 'just now'; }
  }
  function shortId(id=''){ if(!id) return ''; return id.slice(0,4) + '…' + id.slice(-3); }

  // Convert file to base64 (small compression)
  function fileToBase64(file, maxW=1200, q=0.82){
    return new Promise((res,rej)=>{
      const reader = new FileReader();
      reader.onload = (e)=>{
        const img = new Image(); img.onload = ()=>{
          const scale = Math.min(1, maxW/img.width);
          const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
          const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
          const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
          res(canvas.toDataURL('image/jpeg', q));
        };
        img.onerror = rej; img.src = e.target.result;
      };
      reader.onerror = rej; reader.readAsDataURL(file);
    });
  }

  // AUTH GATE
  onAuthStateChanged(auth, async (user)=>{
    // avoid redirect loop: only redirect user->auth if not already on auth page
    try {
      if(!user){
        authResolved = true;
        const path = window.location.pathname.split("/").pop();
        if(path !== "auth.html"){
          // send to auth page
          location.href = "auth.html";
        } else {
          // we are already on auth page — allow
          return;
        }
        return;
      }
      // user logged in
      me = user;
      await ensureUserDoc(user);
      await hydrateUI();
      authResolved = true;
    } catch(err){
      console.error('auth gate error', err);
      authResolved = true;
      byId('gate').style.display = 'none';
      byId('root').classList.remove('hidden');
      toast('Auth error, try reloading','error');
    }
  });

  // If auth check doesn't resolve in 8s, unstick UI but don't redirect
  setTimeout(()=> {
    if(!authResolved){
      // hide gate and let page load with fallback UI; user will be redirected by onAuthStateChanged later
      try{ byId('gate').style.display = 'none'; byId('root').classList.remove('hidden'); }catch{}
      toast('Auth check taking long — if you are not logged in you will be sent to login','error');
    }
  }, 8000);

  async function ensureUserDoc(user){
    const ref = doc(db,'users',user.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      const nick = user.displayName || ('Player_'+user.uid.slice(0,4));
      await setDoc(ref, {
        uid: user.uid,
        nickname: nick,
        gamerName: nick,
        avatar: user.photoURL || initialsAvatar(nick),
        bio: '', sex:'', dob:'', language:'', country:'', games:'',
        points: 0, status:'online', createdAt: serverTimestamp(), updatedAt: serverTimestamp()
      });
      meDoc = (await getDoc(ref)).data();
    } else {
      meDoc = snap.data();
      if(!meDoc.avatar){
        await updateDoc(ref, { avatar: initialsAvatar(meDoc.nickname || 'Player') });
        meDoc = (await getDoc(ref)).data();
      }
    }
  }

  // hydrate UI and attach listeners
  async function hydrateUI(){
    byId('gate').style.display = 'none';
    byId('root').classList.remove('hidden');

    // set header/profile visuals
    const fallback = meDoc.avatar || initialsAvatar(meDoc.nickname || 'Player');
    const avatarIds = ['navAvatar','cpAvatar','sideAvatar','pvAvatar'];
    avatarIds.forEach(id => { if(byId(id)) byId(id).src = fallback; });
    byId('navNick').textContent = meDoc.nickname || 'Player';
    byId('sideNick').textContent = meDoc.nickname || 'Player';
    byId('sidePoints').textContent = meDoc.points || 0;
    byId('pvNick').textContent = meDoc.nickname || 'Player';
    byId('pvPoints').textContent = meDoc.points || 0;
    byId('sideRank').textContent = rankFromPoints(meDoc.points || 0);
    byId('pvRank').textContent = rankFromPoints(meDoc.points || 0);

    // admin UI
    if(me.uid === ADMIN_UID) byId('adminCard').classList.remove('hidden'); else byId('adminCard').classList.add('hidden');

    bindUIEvents();
    startFeed();
    startNotifications();
    loadSuggestions();
    loadFriendAssets();
    loadLeaderboard();
    preloadProfileInputs();
    showSection('feed');
  }

  function rankFromPoints(p=0){
    if(p>2000) return 10;
    if(p>1000) return 9;
    if(p>600) return 8;
    if(p>400) return 7;
    if(p>250) return 6;
    if(p>150) return 5;
    if(p>90) return 4;
    if(p>50) return 3;
    if(p>20) return 2;
    return 1;
  }

  // UI event binding
  function bindUIEvents(){
    byId('burger').addEventListener('click', toggleSidebar);
    // nav buttons
    $$('.navbtn').forEach(b => b.addEventListener('click', ()=> showSection(b.dataset.section)));
    $$('.tab').forEach(t=> t.addEventListener('click', ()=> { showSection(t.dataset.section); $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); }));
    byId('profileBtn').addEventListener('click', ()=> byId('profileMenu').classList.toggle('show'));
    document.addEventListener('click', (e)=>{ if(!byId('profileBtn').contains(e.target) && !byId('profileMenu').contains(e.target)) byId('profileMenu').classList.remove('show'); });
    byId('btnLogout').addEventListener('click', ()=> signOut(auth));

    // header search debounce
    let debounce;
    const sbox = byId('searchBox');
    if(sbox) sbox.addEventListener('input', e=>{
      clearTimeout(debounce);
      debounce = setTimeout(()=> filterFeed(e.target.value.trim().toLowerCase()), 300);
    });

    // post image
    const postImgEl = byId('postImage');
    if(postImgEl) postImgEl.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if(!f) { pendingImgBase64 = null; return; }
      if(f.size > 5*1024*1024){ toast('Image too large (5MB max)','error'); e.target.value=''; pendingImgBase64=null; return; }
      try{ pendingImgBase64 = await fileToBase64(f, 1200, .82); toast('Image attached'); } catch(e){ toast('Image processing failed','error'); pendingImgBase64=null; }
    });

    // create post
    byId('btnPost').addEventListener('click', createPost);

    // image viewer
    byId('imgClose').addEventListener('click', ()=> { byId('imgViewer').classList.add('hidden'); byId('imgLarge').src=''; });

    // chat send
    byId('btnSendChat').addEventListener('click', sendChat);
    byId('chatInput').addEventListener('keydown', (e)=> { if(e.key === 'Enter') sendChat(); });

    // profile save/edit
    byId('btnSaveProfile').addEventListener('click', saveProfile);
    byId('btnEditProfile').addEventListener('click', ()=> { byId('profileView').classList.add('hidden'); byId('profileEdit').classList.remove('hidden'); });

    // admin delete post
    byId('btnAdminDeletePost').addEventListener('click', async ()=>{
      if(me.uid !== ADMIN_UID){ toast('Not admin','error'); return; }
      const id = byId('adminDeletePostId').value.trim(); if(!id) return toast('Add post id','error');
      if(await confirmDialog('Delete post','Permanently delete?')){ await deleteDoc(doc(db,'posts',id)); toast('Deleted','ok'); }
    });

    // friend suggestions refresh
    byId('refreshSuggestions').addEventListener('click', loadSuggestions);

    // mark seen notifs
    byId('btnClearSeen').addEventListener('click', async ()=>{
      const q = query(collection(db,'users',me.uid,'notifications'), where('seen','==',false), limit(50));
      const snaps = await getDocs(q);
      for(const d of snaps.docs) await updateDoc(doc(db,'users',me.uid,'notifications',d.id), { seen:true });
      toast('Marked seen');
    });

    // delegation: friend chat click
    const friendListEl = byId('friendList');
    if(friendListEl) friendListEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-chat]');
      if(!btn) return;
      const uid = btn.dataset.chat;
      if(uid) openChatWithUid(uid);
    });

    // chatUsers delegation
    const chatUsersEl = byId('chatUsers');
    if(chatUsersEl) chatUsersEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-open]');
      if(!btn) return;
      const uid = btn.dataset.open;
      if(uid) openChatWithUid(uid);
    });

    // global delegation for posts
    document.addEventListener('click', (e)=>{
      const likeBtn = e.target.closest('[data-like]');
      if(likeBtn){ const postId = likeBtn.dataset.like; toggleLike(postId); return; }
      const cbtn = e.target.closest('[data-cmt-toggle]');
      if(cbtn){ const id = cbtn.dataset.cmtToggle; toggleComments(id); return; }
      const sendC = e.target.closest('[data-cmt-send]');
      if(sendC){ const id = sendC.dataset.cmtSend; sendComment(id); return; }
      const mbtn = e.target.closest('[data-more]');
      if(mbtn){ const id = mbtn.dataset.more; const menu = byId(`menu-${id}`); if(menu) menu.classList.toggle('show'); return; }
      const addBtn = e.target.closest('[data-add-user]'); if(addBtn){ sendFriendRequest(addBtn.dataset.addUser); return; }
      const reportBtn = e.target.closest('[data-report]'); if(reportBtn){ reportPost(reportBtn.dataset.report); return; }
      const delBtn = e.target.closest('[data-delete-post]'); if(delBtn){ deletePost(delBtn.dataset.deletePost); return; }
      const img = e.target.closest('.img-thumb'); if(img){ byId('imgLarge').src = img.src; byId('imgViewer').classList.remove('hidden'); return; }
    });
  }

  // section switching and cleanup
  function showSection(name){
    if(name !== 'chat' && chatUnsub){ chatUnsub(); chatUnsub = null; currentChatCid = null; byId('chatStream').innerHTML = ''; }
    ['feed','chat','friends','leaderboard','notifications','profile'].forEach(s=>{
      const el = byId(`section-${s}`); if(el) el.classList.toggle('hidden', s!==name);
    });
    $$('.navbtn').forEach(b=> b.classList.toggle('nav-active', b.dataset.section === name));
    $$('.tab').forEach(t=> t.classList.toggle('active', t.dataset.section === name));
    window.scrollTo({top:0, behavior:'smooth'});
  }

  function toggleSidebar(){
    const nav = byId('leftNav');
    if(nav.classList.contains('hidden')) nav.classList.remove('hidden'); else nav.classList.add('hidden');
  }

  /* ========== FEED ========== */
  async function startFeed(){
    byId('feedSkeleton').classList.remove('hidden');
    const q = query(collection(db,'posts'), orderBy('createdAt','desc'), limit(30));
    if(feedUnsub) feedUnsub();
    feedUnsub = onSnapshot(q, snap=>{
      byId('feedSkeleton').classList.add('hidden');
      const list = byId('feedList'); list.innerHTML = '';
      snap.forEach(d => list.appendChild(renderPost(d.id, d.data())));
    }, err => {
      console.error('feed error', err); toast('Failed to load feed','error');
      byId('feedSkeleton').classList.add('hidden');
    });
  }

  async function createPost(){
    const text = byId('postText').value.trim();
    const link = byId('postLink').value.trim() || null;
    if(!text && !pendingImgBase64 && !link){ toast('Write something or attach an image','error'); return; }
    try{
      await addDoc(collection(db,'posts'), {
        uid: me.uid, nickname: meDoc.nickname || 'Player', avatar: meDoc.avatar || initialsAvatar(meDoc.nickname || 'Player'),
        text: text || null, link: link || null, image: pendingImgBase64 || null,
        likes: 0, comments: 0, createdAt: serverTimestamp()
      });
      // reward (best-effort)
      try{ await updateDoc(doc(db,'users',me.uid), { points: (meDoc.points||0) + 5 }); }catch(e){}
      byId('postText').value=''; byId('postLink').value=''; byId('postImage').value=''; pendingImgBase64=null;
      toast('Posted', 'ok');
    }catch(e){ console.error(e); toast('Post failed','error'); }
  }

  // render post card
  function renderPost(id, p){
    const el = document.createElement('div'); el.className = 'glass p-3 rounded relative';
    const created = tsToText(p.createdAt);
    const avatar = p.avatar || initialsAvatar(p.nickname || 'Player');
    el.innerHTML = `
      <div class="flex gap-3">
        <img src="${avatar}" class="w-12 h-12 rounded object-cover">
        <div class="flex-1 relative">
          <div class="flex justify-between items-start">
            <div><div class="font-semibold">${escapeHtml(p.nickname||'Player')} <span class="tiny muted">· ${created}</span></div></div>
            <div>
              <button data-more="${id}" class="px-2 py-1 rounded hover:bg-white/5 btn"><i class="fa fa-ellipsis"></i></button>
              <div id="menu-${id}" class="menu glass rounded p-1 hidden">
                <button class="w-full text-left px-2 py-1 tiny" data-add-user="${p.uid}">Add user</button>
                <button class="w-full text-left px-2 py-1 tiny" data-report="${id}">Report</button>
                ${(me.uid===p.uid || me.uid===ADMIN_UID) ? `<button class="w-full text-left px-2 py-1 tiny text-red-400" data-delete-post="${id}">Delete</button>` : ''}
              </div>
            </div>
          </div>
          ${p.text ? `<div class="mt-2 post-text text-sm">${escapeHtml(p.text)}</div>` : ''}
          ${p.link ? `<div class="mt-2"><a class="text-[var(--mh-accent)] tiny" target="_blank" rel="noopener" href="${escapeHtml(p.link)}">${escapeHtml(p.link)}</a></div>` : ''}
          ${p.image ? `<img src="${p.image}" class="img-thumb mt-2" loading="lazy">` : ''}
          <div class="mt-2 flex items-center justify-between tiny muted">
            <div><span id="likes-${id}">${p.likes||0}</span> likes · <span id="cmts-${id}">${p.comments||0}</span> comments</div>
            <div></div>
          </div>
          <div class="mt-2 grid grid-cols-3 gap-2">
            <button class="reaction-btn px-2 py-2 rounded bg-white/5 tiny" data-like="${id}"><i class="fa-regular fa-thumbs-up"></i> Like</button>
            <button class="reaction-btn px-2 py-2 rounded bg-white/5 tiny" data-cmt-toggle="${id}"><i class="fa-regular fa-comment"></i> Comment</button>
            <button class="reaction-btn px-2 py-2 rounded bg-white/5 tiny" data-share="${id}"><i class="fa fa-share"></i> Share</button>
          </div>
          <div id="cbox-${id}" class="comments-hidden mt-2">
            <div id="cList-${id}" class="space-y-2 max-h-48 overflow-auto"></div>
            <div class="flex gap-2 mt-2">
              <input id="cInput-${id}" class="flex-1 bg-[var(--mh-panel)] p-2 rounded tiny" placeholder="Write a comment...">
              <button class="px-3 py-1 bg-[var(--mh-primary)] rounded tiny" data-cmt-send="${id}">Send</button>
            </div>
          </div>
        </div>
      </div>
    `;
    return el;
  }

  // toggle comments: lazy subscribe
  const commentUnsubs = {};
  function toggleComments(postId){
    const box = byId(`cbox-${postId}`);
    if(!box) return;
    const isHidden = box.classList.contains('comments-hidden');
    if(isHidden){
      box.classList.remove('comments-hidden');
      const q = query(collection(db,'posts',postId,'comments'), orderBy('createdAt','asc'), limit(200));
      const unsubC = onSnapshot(q, snap=>{
        const list = byId(`cList-${postId}`); list.innerHTML = '';
        snap.forEach(d=>{
          const c = d.data();
          const row = document.createElement('div'); row.className='flex gap-2 items-start';
          row.innerHTML = `<img src="${c.avatar || initialsAvatar(c.nickname||'P')}" class="w-8 h-8 rounded object-cover"><div class="bg-white/5 p-2 rounded"><div class="tiny font-semibold">${escapeHtml(c.nickname||'Player')}</div><div class="tiny">${escapeHtml(c.text)}</div><div class="tiny muted mt-1">${tsToText(c.createdAt)}</div></div>`;
          list.appendChild(row);
        });
      }, err=> console.error('comments err', err));
      commentUnsubs[postId] = unsubC;
    } else {
      box.classList.add('comments-hidden');
      if(commentUnsubs[postId]) { commentUnsubs[postId](); delete commentUnsubs[postId]; }
    }
  }

  async function sendComment(postId){
    const input = byId(`cInput-${postId}`); if(!input) return;
    const text = input.value.trim(); if(!text) return;
    await addDoc(collection(db,'posts',postId,'comments'), {
      uid: me.uid, nickname: meDoc.nickname, avatar: meDoc.avatar || initialsAvatar(meDoc.nickname), text, createdAt: serverTimestamp()
    });
    await updateDoc(doc(db,'posts',postId), { comments: (Number(byId(`cmts-${postId}`)?.textContent||0) + 1) }).catch(()=>{});
    input.value = '';
    toast('Comment sent','ok');
  }

  /* Toggle like with runTransaction to ensure counts & owner points are consistent */
  async function toggleLike(postId){
    const postRef = doc(db,'posts',postId);
    const likeRef = doc(db,'posts',postId,'likes', me.uid);
    try{
      await runTransaction(db, async (t)=>{
        const likeSnap = await t.get(likeRef);
        const postSnap = await t.get(postRef);
        if(!postSnap.exists()) throw new Error('Post not found');
        const postData = postSnap.data();
        const ownerUid = postData.uid;
        if(likeSnap.exists()){
          // unlike
          t.delete(likeRef);
          t.update(postRef, { likes: (postData.likes||1) - 1 });
          if(ownerUid && ownerUid !== me.uid){
            const ownerRef = doc(db,'users',ownerUid);
            const ownerSnap = await t.get(ownerRef);
            const curPts = ownerSnap.exists() ? (ownerSnap.data().points || 0) : 0;
            t.update(ownerRef, { points: curPts - 1 });
          }
        } else {
          // like
          t.set(likeRef, { uid: me.uid, createdAt: serverTimestamp() });
          t.update(postRef, { likes: (postData.likes||0) + 1 });
          if(ownerUid && ownerUid !== me.uid){
            const ownerRef = doc(db,'users',ownerUid);
            const ownerSnap = await t.get(ownerRef);
            const curPts = ownerSnap.exists() ? (ownerSnap.data().points || 0) : 0;
            t.update(ownerRef, { points: curPts + 1 });
            // notification best-effort (outside transaction)
            addDoc(collection(db,'users',ownerUid,'notifications'), { type:'like', fromUid: me.uid, fromNick: meDoc.nickname, postId, createdAt: serverTimestamp(), seen:false }).catch(()=>{});
          }
        }
      });
    }catch(e){
      console.error('like error', e);
      toast('Like action failed', 'error');
    }
  }

  async function reportPost(postId){
    await addDoc(collection(db,'posts',postId,'reports'), { from: me.uid, createdAt: serverTimestamp() });
    toast('Reported', 'ok');
  }
  async function deletePost(postId){
    const pDoc = await getDoc(doc(db,'posts',postId));
    if(!(me.uid === ADMIN_UID || (pDoc.exists() && pDoc.data().uid === me.uid))){ toast('No permission','error'); return; }
    if(await confirmDialog('Delete post','Permanently delete?')){ await deleteDoc(doc(db,'posts',postId)); toast('Deleted','ok'); }
  }

  /* ========= FRIENDS ========= */
  async function loadSuggestions(){
    const q = query(collection(db,'users'), orderBy('createdAt','desc'), limit(48));
    const snaps = await getDocs(q);
    const container = byId('friendSuggestions'); container.innerHTML = '';
    snaps.forEach(d=>{
      const u = d.data(); if(!u || u.uid === me.uid) return;
      const card = document.createElement('div'); card.className='p-2 bg-white/3 rounded flex flex-col items-center gap-2';
      card.innerHTML = `<img src="${u.avatar || initialsAvatar(u.nickname)}" class="w-12 h-12 rounded"><div class="tiny font-semibold">${u.nickname||shortId(u.uid)}</div><button class="px-2 py-1 bg-[var(--mh-primary)] rounded tiny" data-sug="${u.uid}">Add</button>`;
      card.querySelector('[data-sug]')?.addEventListener('click', ()=> sendFriendRequest(u.uid));
      container.appendChild(card);
    });
  }

  async function sendFriendRequest(toUid){
    if(toUid === me.uid) return toast("Can't add yourself",'error');
    // prevent duplicates (client-side check)
    const q1 = query(collection(db,'friendRequests'), where('from','==',me.uid), where('to','==',toUid), limit(1));
    const q2 = query(collection(db,'friendRequests'), where('from','==',toUid), where('to','==',me.uid), limit(1));
    const r1 = await getDocs(q1), r2 = await getDocs(q2);
    if(!r1.empty) return toast('Request already sent','error');
    if(!r2.empty){ // mutual -> accept
      const docRef = r2.docs[0];
      await acceptFriend(docRef.id, docRef.data());
      return toast('Accepted mutual request','ok');
    }
    await addDoc(collection(db,'friendRequests'), { from: me.uid, to: toUid, fromNick: meDoc.nickname, fromAvatar: meDoc.avatar || initialsAvatar(meDoc.nickname), createdAt: serverTimestamp() });
    await addDoc(collection(db,'users',toUid,'notifications'), { type:'friend-request', fromUid: me.uid, fromNick: meDoc.nickname, createdAt: serverTimestamp(), seen:false });
    toast('Request sent','ok');
  }

  function loadFriendAssets(){
    // incoming requests
    unsub['friendRequests'] = onSnapshot(query(collection(db,'friendRequests'), where('to','==',me.uid), orderBy('createdAt','desc')), snap=>{
      const container = byId('incomingRequests'); container.innerHTML = '';
      if(snap.empty) container.innerHTML = '<div class="tiny muted">No requests</div>';
      snap.forEach(d=>{
        const r = d.data();
        const row = document.createElement('div'); row.className='flex items-center justify-between gap-2 p-2 bg-white/3 rounded';
        row.innerHTML = `<div class="flex items-center gap-2"><img src="${r.fromAvatar||initialsAvatar(r.fromNick||'U')}" class="w-10 h-10 rounded"><div><div class="tiny font-semibold">${r.fromNick||shortId(r.from)}</div><div class="tiny muted">${tsToText(r.createdAt)}</div></div></div><div class="flex gap-2"><button class="px-2 py-1 bg-[var(--ok)]/20 rounded tiny" data-acc="${d.id}">Accept</button><button class="px-2 py-1 bg-white/5 rounded tiny" data-dec="${d.id}">Decline</button></div>`;
        container.appendChild(row);
        row.querySelector(`[data-acc="${d.id}"]`).addEventListener("click", ()=> acceptFriend(d.id, r));
        row.querySelector(`[data-dec="${d.id}"]`).addEventListener("click", ()=> deleteDoc(doc(db,'friendRequests',d.id)).then(()=>toast('Declined')));
      });
    });

    // friends
    unsub['friends'] = onSnapshot(query(collection(db,'friends')), async snap=>{
      const list = byId('friendList'); const chatBox = byId('chatUsers'); list.innerHTML = ''; chatBox.innerHTML = '';
      const pairs = [];
      snap.forEach(d=> pairs.push(d.data()));
      const myPairs = pairs.filter(p => Array.isArray(p.uids) && p.uids.includes(me.uid));
      if(myPairs.length === 0){ list.innerHTML = '<div class="tiny muted">No friends yet</div>'; chatBox.innerHTML = '<div class="tiny muted">Add friends to chat</div>'; return; }
      for(const fr of myPairs){
        const peerUid = fr.uids.find(u=>u!==me.uid);
        const peerSnap = await getDoc(doc(db,'users',peerUid)); const u = peerSnap.exists() ? peerSnap.data() : { uid: peerUid, nickname: shortId(peerUid), avatar: initialsAvatar('User')};
        const card = document.createElement('div'); card.className='flex items-center justify-between p-2 bg-white/3 rounded';
        card.innerHTML = `<div class="flex items-center gap-2"><img src="${u.avatar||initialsAvatar(u.nickname)}" class="w-10 h-10 rounded"><div><div class="tiny font-semibold">${u.nickname||'Player'}</div><div class="tiny muted">${shortId(u.uid)}</div></div></div><div class="flex gap-2"><button class="px-2 py-1 bg-white/5 rounded tiny" data-chat="${u.uid}">Msg</button><button class="px-2 py-1 bg-red-500/20 rounded tiny" data-unf="${u.uid}">Unfriend</button></div>`;
        list.appendChild(card);
        card.querySelector(`[data-unf="${u.uid}"]`).addEventListener("click", async ()=> {
          if(await confirmDialog('Unfriend','Remove friend?')){ await deleteDoc(doc(db,'friends',[me.uid,u.uid].sort().join('_'))); toast('Removed','ok'); }
        });

        // chat list
        const li = document.createElement('div'); li.className='flex items-center justify-between p-2 bg-white/3 rounded';
        li.innerHTML = `<div class="flex items-center gap-2"><img src="${u.avatar||initialsAvatar(u.nickname)}" class="w-9 h-9 rounded"><div><div class="tiny font-semibold">${u.nickname}</div><div class="tiny muted">Tap to chat</div></div></div><button class="px-2 py-1 bg-white/5 rounded tiny" data-open="${u.uid}"><i class="fa fa-comment"></i></button>`;
        li.querySelector(`[data-open="${u.uid}"]`).addEventListener('click', ()=> openChatWithUid(u.uid));
        chatBox.appendChild(li);
      }
    });
  }

  async function acceptFriend(reqId, req){
    const pair = [req.from, req.to].sort().join('_');
    await setDoc(doc(db,'friends',pair), { uids: [req.from, req.to], since: serverTimestamp() });
    await deleteDoc(doc(db,'friendRequests',reqId));
    toast('Friend added','ok');
  }

  /* ========= PRIVATE CHAT ========= */
  function convoIdFor(a,b){ return [a,b].sort().join('_'); }
  async function openChatWithUid(peerUid){
    const snap = await getDoc(doc(db,'users',peerUid));
    const u = snap.exists() ? snap.data() : { uid: peerUid, nickname: shortId(peerUid), avatar: initialsAvatar('User') };
    byId('chatPeerNick').textContent = u.nickname || 'Player';
    byId('chatPeerAvatar').src = u.avatar || initialsAvatar(u.nickname);
    byId('chatPeerStatus').textContent = 'Online';
    showSection('chat');

    $$('#friendList [data-chat]').forEach(b=> b.classList.toggle('nav-active', b.dataset.chat === peerUid));

    if(chatUnsub){ chatUnsub(); chatUnsub = null; currentChatCid = null; byId('chatStream').innerHTML = ''; }

    const cid = convoIdFor(me.uid, peerUid);
    currentChatCid = cid;
    await setDoc(doc(db,'chats',cid), { members: [me.uid, peerUid], updatedAt: serverTimestamp() }, { merge: true });
    const q = query(collection(db,'chats',cid,'messages'), orderBy('createdAt','asc'), limit(500));
    chatUnsub = onSnapshot(q, snap=>{
      const box = byId('chatStream');
      snap.docChanges().forEach(change=>{
        if(change.type === 'added'){
          const m = change.doc.data();
          const mine = m.from === me.uid;
          const row = document.createElement('div'); row.className = `max-w-[75%] ${mine? 'ml-auto text-right':'mr-auto'}`;
          row.innerHTML = `<div class="p-2 rounded ${mine? 'bg-[var(--mh-primary)] text-white':'bg-white/5'} tiny">${escapeHtml(m.text)}<div class="tiny muted mt-1">${tsToText(m.createdAt)}</div></div>`;
          box.appendChild(row);
        }
      });
      box.scrollTop = box.scrollHeight;
      byId('chatInput').focus();
    }, err=> console.error('chat error', err));
  }

  async function sendChat(){
    const text = byId('chatInput').value.trim(); if(!text || !currentChatCid) return;
    await setDoc(doc(db,'chats',currentChatCid), { updatedAt: serverTimestamp() }, { merge: true });
    await addDoc(collection(db,'chats',currentChatCid,'messages'), { from: me.uid, to: currentChatCid.replace(me.uid,'').replace('_',''), text, createdAt: serverTimestamp() });
    byId('chatInput').value = '';
    toast('Sent','ok');
  }

  /* ========= NOTIFICATIONS ========= */
  function startNotifications(){
    const q = query(collection(db,'users',me.uid,'notifications'), orderBy('createdAt','desc'), limit(100));
    unsub['notifs'] = onSnapshot(q, snap=>{
      const container = byId('notifList'); container.innerHTML = '';
      let unseen = 0;
      snap.forEach(d=>{
        const n = d.data();
        if(!n.seen) unseen++;
        const row = document.createElement('div'); row.className = 'p-2 bg-white/3 rounded flex gap-2 items-start';
        row.innerHTML = `<div class="w-9 h-9 rounded bg-white/5 flex items-center justify-center tiny"><i class="fa ${n.type==='dm'?'fa-message': n.type==='like'?'fa-thumbs-up': n.type==='comment'?'fa-comment':'fa-user-plus'}"></i></div><div class="flex-1"><div class="tiny font-semibold">${n.fromNick || 'Someone'}</div><div class="tiny muted">${n.text||''}</div><div class="tiny muted mt-1">${tsToText(n.createdAt)}</div></div><div><button class="px-2 py-1 bg-white/5 rounded tiny" data-mark="${d.id}">Mark</button></div>`;
        row.querySelector(`[data-mark="${d.id}"]`).addEventListener('click', ()=> updateDoc(doc(db,'users',me.uid,'notifications',d.id), { seen:true }));
        container.appendChild(row);
      });
      byId('notifDot').classList.toggle('hidden', unseen === 0);
    }, err=> console.error(err));
  }

  /* ========= LEADERBOARD ========= */
  function loadLeaderboard(){
    unsub['leader'] = onSnapshot(query(collection(db,'users'), orderBy('points','desc'), limit(50)), snap=>{
      const rows = byId('leaderRows'); rows.innerHTML = ''; let i=0;
      snap.forEach(d => { i++; const u = d.data(); const tr = document.createElement('tr'); tr.innerHTML = `<td class="tiny">${i}</td><td class="tiny">${escapeHtml(u.nickname||shortId(u.uid))}</td><td class="tiny">${u.points||0}</td>`; rows.appendChild(tr); });
    });
  }

  /* ========= PROFILE ========= */
  async function saveProfile(){
    const nickname = byId('setNick').value.trim() || meDoc.nickname || 'Player';
    const gamerName = byId('setGamer').value.trim() || nickname;
    const sex = byId('setSex').value || '';
    const dob = byId('setDob').value || '';
    const language = byId('setLang').value.trim() || '';
    const country = byId('setCountry').value.trim() || '';
    const games = byId('setGames').value.trim() || '';
    const bio = byId('setBio').value.trim() || '';
    let avatarData = meDoc.avatar || initialsAvatar(nickname);
    const f = byId('setAvatar').files?.[0];
    if(f){
      if(f.size > 5*1024*1024){ toast('Avatar too large','error'); return; }
      try{ avatarData = await fileToBase64(f, 800, .8); }catch(e){ toast('Avatar failed','error'); }
    }
    await updateDoc(doc(db,'users',me.uid), { nickname, gamerName, sex, dob, language, country, games, bio, avatar: avatarData, updatedAt: serverTimestamp() });
    meDoc = (await getDoc(doc(db,'users',me.uid))).data();
    ['navAvatar','sideAvatar','cpAvatar','pvAvatar'].forEach(id => { if(byId(id)) byId(id).src = meDoc.avatar || initialsAvatar(meDoc.nickname); });
    byId('navNick').textContent = meDoc.nickname; byId('sideNick').textContent = meDoc.nickname;
    toast('Profile saved','ok'); byId('profileSaved').classList.remove('hidden'); setTimeout(()=> byId('profileSaved').classList.add('hidden'), 1200);
    byId('profileView').classList.remove('hidden'); byId('profileEdit').classList.add('hidden');
    fillProfileView();
  }

  async function preloadProfileInputs(){
    await new Promise(r=>setTimeout(r,200));
    byId('setNick').value = meDoc.nickname || '';
    byId('setGamer').value = meDoc.gamerName || '';
    byId('setSex').value = meDoc.sex || '';
    byId('setDob').value = meDoc.dob || '';
    byId('setLang').value = meDoc.language || '';
    byId('setCountry').value = meDoc.country || '';
    byId('setGames').value = meDoc.games || '';
    byId('setBio').value = meDoc.bio || '';
    fillProfileView();
  }
  function fillProfileView(){
    byId('pvAvatar').src = meDoc.avatar || initialsAvatar(meDoc.nickname);
    byId('pvNick').textContent = meDoc.nickname || 'Player';
    byId('pvPoints').textContent = meDoc.points || 0;
    byId('pvRank').textContent = rankFromPoints(meDoc.points||0);
    byId('pvBio').textContent = meDoc.bio || '';
    byId('pvGamer').textContent = meDoc.gamerName || '';
    byId('pvSex').textContent = meDoc.sex || '';
    byId('pvDob').textContent = meDoc.dob || '';
    byId('pvLang').textContent = meDoc.language || '';
    byId('pvCountry').textContent = meDoc.country || '';
    byId('pvGames').textContent = meDoc.games || '';
    byId('profileView').classList.remove('hidden');
    byId('profileEdit').classList.add('hidden');
  }

  /* ========= CLEANUP ========= */
  window.addEventListener('beforeunload', ()=> {
    if(feedUnsub) feedUnsub();
    if(chatUnsub) chatUnsub();
    Object.values(unsub).forEach(f => { try{ if(typeof f==='function') f(); } catch{} });
    Object.values(commentUnsubs).forEach(f => { try{ f(); } catch{} });
  });

  /* small helpers */
  function escapeHtml(s=''){ return String(s).replace(/[&<>"'`]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[c])); }

  // simple feed filter
  function filterFeed(q){
    const items = byId('feedList').children;
    for(const card of items) card.style.display = card.textContent.toLowerCase().includes(q) ? '' : 'none';
  }
</script>

<!-- small non-module helpers -->
<script>
  document.addEventListener('click', (e)=>{
    const menuEls = document.querySelectorAll('.menu.show');
    menuEls.forEach(m => { if(!m.contains(e.target) && !e.target.closest('[data-more]')) m.classList.remove('show'); });
  });
</script>

</body>
</html>